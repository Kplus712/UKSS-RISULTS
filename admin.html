<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS ‚Äî Admin (Secure Popup)</title>
  <meta name="theme-color" content="#071427" />
  <style>
    :root{ --bg:#071427; --muted:#9fb0c6; --accent:#bfa034; font-family:Inter,system-ui,Arial }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#07111a,#071427);color:#e6eef6}
    .app{display:flex;min-height:100vh}
    aside.sidebar{width:220px;padding:18px;background:linear-gradient(180deg,#06332a,#072b20);border-right:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:18px}
    .brand-badge{background:var(--accent);color:#071225;padding:8px;border-radius:8px;font-weight:800}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--muted);text-decoration:none;padding:8px;border-radius:8px;cursor:pointer}
    .nav a.active{background:rgba(191,160,52,0.12);color:var(--accent);font-weight:700}
    main.main{flex:1;padding:18px;overflow:auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .small{font-size:13px;color:var(--muted)}
    .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
    input,textarea,select{width:100%;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit}
    .btn{background:var(--accent);color:#071225;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    thead th{font-size:13px;color:var(--muted);text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)}
    tbody td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    /* HIDE admin area until verified */
    .admin-locked{display:none}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:9999}
    .modal-backdrop.active{display:flex}
    .modal{width:420px;background:linear-gradient(180deg,#071427,#061025);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.06)}
    .error{color:#ff9b9b;margin-top:8px}
    @media(max-width:900px){ aside.sidebar{display:none} }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge">UK</div>
        <div>
          <div style="font-weight:800">UKSS</div>
          <div class="small muted">Results Management</div>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="marks.html">üè† Marks</a>
        <a href="results.html">üìÑ Results</a>
        <a href="ranking.html">üèÜ Ranking</a>
        <a href="behaviour.html">üß≠ Behaviour</a>
        <a href="sms.html">üì® SMS</a>
        <a href="sms_logs.html">üßæ SMS Logs</a>
        <!-- IMPORTANT: Admin link is NOT a normal link, it only opens modal -->
        <a id="navAdmin" class="active" role="button" aria-haspopup="dialog">üîê Admin</a>
      </nav>
    </aside>

    <main class="main" id="mainContent">
      <header class="topbar">
        <div>
          <h2>üîê Admin Control Center</h2>
          <p class="small">Full control kwa system owner: staff roles, system settings, logs na approvals za access.</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="signedInBadge" class="small muted">Not signed in</div>
          <button id="openAdminBtn" class="btn ghost">Admin Login</button>
          <button id="logoutBtn" class="btn ghost">Logout</button>
        </div>
      </header>

      <!-- Everything admin-sensitive is wrapped in .admin-locked -->
      <div class="admin-locked" id="adminArea">
        <section class="card">
          <h3>Your Account</h3>
          <p class="small">Hapa unaona taarifa zako na role uliyopewa. Kazi za admin zipo chini.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div style="flex:1;min-width:160px">
              <label class="small muted">Name</label>
              <input id="meName" disabled />
            </div>
            <div style="flex:1;min-width:160px">
              <label class="small muted">Email</label>
              <input id="meEmail" disabled />
            </div>
            <div style="flex:1;min-width:160px">
              <label class="small muted">Role</label>
              <input id="meRole" disabled />
            </div>
            <div style="flex:1;min-width:160px">
              <label class="small muted">Main Class</label>
              <input id="meClass" disabled />
            </div>
          </div>
        </section>

        <section class="card">
          <h3>1. Staff Management</h3>
          <p class="small">Badili roles, class na status ya staff.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <input id="staffSearch" placeholder="Search name/email..." style="width:320px" />
            <div>
              <button id="reloadStaffBtn" class="btn ghost">Reload</button>
              <button id="saveAllStaffBtn" class="btn">Save All</button>
            </div>
          </div>
          <div style="margin-top:10px;max-height:260px;overflow:auto">
            <table id="staffTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Main Class</th><th>Active</th><th>Updated</th><th></th></tr></thead><tbody><tr><td colspan="7" class="muted">Loading...</td></tr></tbody></table>
          </div>
        </section>

        <section class="card">
          <h3>2. Access Control & Approvals</h3>
          <p class="small">Pending staff will appear here.</p>
          <div style="margin-top:8px;max-height:160px;overflow:auto">
            <table id="pendingTable"><thead><tr><th>Name</th><th>Email</th><th>Current Role</th><th>New Role</th><th>Set Active</th><th>Apply</th></tr></thead><tbody><tr><td colspan="6" class="muted">No pending staff.</td></tr></tbody></table>
          </div>
        </section>

        <section class="card">
          <h3>3. System Settings</h3>
          <p class="small">Stored at <code>settings/global</code>.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div style="flex:1;min-width:180px"><label class="small muted">School Name</label><input id="setSchoolName" /></div>
            <div style="flex:1;min-width:120px"><label class="small muted">Academic Year</label><input id="setAcademicYear" /></div>
            <div style="flex:1;min-width:140px"><label class="small muted">SMS Provider</label><input id="setSmsProvider" /></div>
          </div>
          <div style="margin-top:8px"><label class="small muted">Grading Note</label><textarea id="setGradingNote" rows="3"></textarea></div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
            <button id="saveSettingsBtn" class="btn">Save Settings</button><span id="settingsStatus" class="small muted"></span>
          </div>
        </section>

        <section class="card" style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:280px">
            <h3>Exam Period</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <div style="flex:1"><label class="small muted">Start</label><input id="examStart" type="date" /></div>
              <div style="flex:1"><label class="small muted">End</label><input id="examEnd" type="date" /></div>
              <div style="width:140px"><label class="small muted">Days left</label><div id="examCountdown" class="countdown">‚Äî</div></div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
              <button id="saveExamBtn" class="btn">Save Period</button>
              <button id="clearExamBtn" class="btn ghost">Clear</button>
            </div>
          </div>

          <div style="width:320px">
            <h3>Logs & Overview</h3>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1"><div class="small muted">Staff</div><div id="staffCount">‚Äî</div></div>
              <div style="flex:1"><div class="small muted">Students</div><div id="studentsCount">‚Äî</div></div>
              <div style="flex:1"><div class="small muted">Notifications</div><div id="notifCount">‚Äî</div></div>
            </div>
            <div style="margin-top:10px"><button id="openLogsBtn" class="btn ghost">Open Logs</button></div>
          </div>
        </section>
      </div> <!-- admin-locked -->
    </main>
  </div>

  <!-- Modal (popup sign-in) -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Admin sign-in</h3>
      <p class="small muted">Enter email & password. Password required even if already signed in.</p>
      <div style="margin-top:8px"><input id="modalEmail" placeholder="Email (leave to reauth current user)"/></div>
      <div style="margin-top:8px"><input id="modalPassword" type="password" placeholder="Password"/></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="modalCancel" class="btn ghost">Cancel</button>
        <button id="modalSubmit" class="btn">Sign in</button>
      </div>
      <div id="modalError" class="error" aria-live="polite" style="min-height:18px"></div>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // -- your firebase config (as provided) --
  const firebaseConfig = {
    apiKey: "AIzaSyA8QMDOD-bUXpElehkg2BlJhKE1_cbvKek",
    authDomain: "school-results-management.firebaseapp.com",
    databaseURL: "https://school-results-management-default-rtdb.firebaseio.com",
    projectId: "school-results-management",
    storageBucket: "school-results-management.firebasestorage.app",
    messagingSenderId: "755154296958",
    appId: "1:755154296958:web:e4c5f9bc0e6cce3e9cf82f",
    measurementId: "G-MDN4Q3C22J"
  };
  if(!window.firebase) throw new Error('Firebase SDK not loaded.');
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  // -- end config --

  (function(){
    // UI refs
    const navAdmin = document.getElementById('navAdmin');
    const openAdminBtn = document.getElementById('openAdminBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const modal = document.getElementById('modal');
    const modalEmail = document.getElementById('modalEmail');
    const modalPassword = document.getElementById('modalPassword');
    const modalCancel = document.getElementById('modalCancel');
    const modalSubmit = document.getElementById('modalSubmit');
    const modalError = document.getElementById('modalError');

    const adminArea = document.getElementById('adminArea');
    const signedInBadge = document.getElementById('signedInBadge');

    // account & staff refs
    const meName = document.getElementById('meName');
    const meEmail = document.getElementById('meEmail');
    const meRole = document.getElementById('meRole');
    const meClass = document.getElementById('meClass');

    const staffTable = document.getElementById('staffTable').querySelector('tbody');
    const staffSearch = document.getElementById('staffSearch');
    const reloadStaffBtn = document.getElementById('reloadStaffBtn');
    const saveAllStaffBtn = document.getElementById('saveAllStaffBtn');
    const pendingTable = document.getElementById('pendingTable').querySelector('tbody');

    const setSchoolName = document.getElementById('setSchoolName');
    const setAcademicYear = document.getElementById('setAcademicYear');
    const setSmsProvider = document.getElementById('setSmsProvider');
    const setGradingNote = document.getElementById('setGradingNote');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const settingsStatus = document.getElementById('settingsStatus');

    const examStart = document.getElementById('examStart');
    const examEnd = document.getElementById('examEnd');
    const examCountdown = document.getElementById('examCountdown');
    const saveExamBtn = document.getElementById('saveExamBtn');
    const clearExamBtn = document.getElementById('clearExamBtn');

    const staffCountEl = document.getElementById('staffCount');
    const studentsCountEl = document.getElementById('studentsCount');
    const notifCountEl = document.getElementById('notifCount');
    const openLogsBtn = document.getElementById('openLogsBtn');

    // state
    let staffList = [];
    let studentsList = [];
    let notificationsList = [];
    let currentStaffRecord = null;
    let adminVerified = false;

    // ensure Admin link doesn't navigate or show anything; it only triggers modal
    navAdmin.addEventListener('click', (e)=> {
      e.preventDefault();
      openModal();
    });
    openAdminBtn.addEventListener('click', openModal);

    function openModal(){
      modal.classList.add('active');
      modal.style.display = 'flex';
      modalError.textContent = '';
      modalEmail.value = auth.currentUser ? (auth.currentUser.email || '') : '';
      modalPassword.value = '';
      modalPassword.focus();
    }
    function closeModal(){ modal.classList.remove('active'); modal.style.display = 'none'; modalPassword.value=''; modalError.textContent=''; }

    modalCancel.addEventListener('click', closeModal);
    modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); });

    // logout
    logoutBtn.addEventListener('click', async ()=>{
      try{
        await auth.signOut();
        adminVerified = false;
        hideAdminArea();
        alert('Signed out');
      }catch(err){ console.error(err); alert('Sign out failed'); }
    });

    // modal submit: strict reauth/sign-in
    modalSubmit.addEventListener('click', async ()=>{
      modalError.textContent = '';
      modalSubmit.disabled = true;
      const email = (modalEmail.value||'').trim();
      const pw = modalPassword.value || '';
      if(!pw){ modalError.textContent = 'Ingiza password.'; modalSubmit.disabled = false; return; }

      try{
        let user;
        if(auth.currentUser && (!email || auth.currentUser.email === email)){
          const cred = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, pw);
          await auth.currentUser.reauthenticateWithCredential(cred);
          user = auth.currentUser;
        } else {
          const res = await auth.signInWithEmailAndPassword(email, pw);
          user = res.user;
        }

        // check staff record/role
        const ok = await checkStaffIsAdmin(user);
        if(!ok){
          modalError.textContent = 'Account hii hauna ruhusa ya Admin.';
          try{ await auth.signOut(); } catch(e){}
          modalSubmit.disabled = false;
          return;
        }

        // success
        adminVerified = true;
        closeModal();
        populateAccountInfo(user, currentStaffRecord);
        signedInBadge.textContent = 'Signed in: ' + (user.email || user.uid);
        showAdminArea();
        await loadCounts();
        await loadStaff();
        await loadPending();
      }catch(err){
        console.error('modal sign-in', err);
        if(err && err.message && err.message.includes('API key not valid')) modalError.textContent = 'API key invalid ‚Äî hakikisha firebaseConfig.';
        else if(err && err.code === 'auth/wrong-password') modalError.textContent = 'Password sio sahihi.';
        else modalError.textContent = err.message || 'Login failed';
      } finally {
        modalSubmit.disabled = false;
        modalPassword.value = '';
      }
    });

    // check staff doc & role
    async function checkStaffIsAdmin(user){
      if(!user) return false;
      currentStaffRecord = null;
      try{
        const doc = await db.collection('staff').doc(user.uid).get();
        if(doc.exists) currentStaffRecord = { id: doc.id, ...doc.data() };
        else {
          const q = await db.collection('staff').where('email','==', user.email).limit(1).get();
          if(!q.empty) currentStaffRecord = { id: q.docs[0].id, ...q.docs[0].data() };
        }
        if(!currentStaffRecord) return false;
        return (currentStaffRecord.role||'').toLowerCase().includes('admin');
      }catch(err){ console.error('checkStaffIsAdmin', err); throw err; }
    }

    function populateAccountInfo(user, staffRec){
      meName.value = staffRec && staffRec.name || user.displayName || '';
      meEmail.value = user.email || user.uid || '';
      meRole.value = staffRec && staffRec.role || '';
      meClass.value = staffRec && staffRec.mainClass || '';
    }

    function showAdminArea(){
      document.getElementById('adminArea').style.display = 'block';
    }
    function hideAdminArea(){
      document.getElementById('adminArea').style.display = 'none';
      staffTable.querySelector('tbody').innerHTML = '<tr><td colspan="7" class="muted">Sign in as Admin to manage staff.</td></tr>';
      staffCountEl.textContent = '‚Äî'; studentsCountEl.textContent='‚Äî'; notifCountEl.textContent='‚Äî';
      signedInBadge.textContent = auth.currentUser ? 'Signed in (not verified)' : 'Not signed in';
    }

    // loadCounts (only when adminVerified)
    async function loadCounts(){
      if(!adminVerified){ staffCountEl.textContent='‚Äî'; studentsCountEl.textContent='‚Äî'; notifCountEl.textContent='‚Äî'; return; }
      try{
        const [s1,s2,s3] = await Promise.all([ db.collection('staff').get(), db.collection('students').get(), db.collection('notifications').get() ]);
        staffCountEl.textContent = s1.size; studentsCountEl.textContent = s2.size; notifCountEl.textContent = s3.size;
      }catch(err){ console.error('loadCounts', err); staffCountEl.textContent='err'; studentsCountEl.textContent='err'; notifCountEl.textContent='err'; }
    }

    // load staff
    async function loadStaff(){
      if(!adminVerified){ hideAdminArea(); return; }
      const tbody = staffTable.querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
      try{
        const snap = await db.collection('staff').orderBy('name','asc').get();
        staffList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if(staffList.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="muted">No staff found.</td></tr>'; return; }
        tbody.innerHTML = staffList.map(s => {
          const active = s.active ? 'checked' : '';
          return `<tr data-id="${s.id}"><td><strong>${escapeHtml(s.name||'')}</strong></td><td>${escapeHtml(s.email||'')}</td>
            <td><select class="roleSel"><option ${s.role==='Admin'?'selected':''}>Admin</option><option ${s.role==='Headmaster'?'selected':''}>Headmaster</option><option ${s.role==='Academic'?'selected':''}>Academic</option><option ${s.role==='Class Teacher'?'selected':''}>Class Teacher</option></select></td>
            <td><input class="mainClassInput" value="${escapeHtml(s.mainClass||'')}" /></td>
            <td><button class="toggleBtn ${active}"></button></td><td>${escapeHtml(s.updated||'')}</td>
            <td style="white-space:nowrap"><button class="btn ghost saveRowBtn" data-id="${s.id}" style="padding:6px 8px">Save</button> <button class="btn ghost deleteRowBtn" data-id="${s.id}" style="padding:6px 8px">Delete</button></td></tr>`;
        }).join('');
      }catch(err){
        console.error('loadStaff', err);
        tbody.innerHTML = `<tr><td colspan="7" class="danger">Failed to load staff: ${escapeHtml(err.message||err)}</td></tr>`;
      }
    }

    // staff event delegation (write ops require adminVerified)
    staffTable.addEventListener('click', async (ev)=>{
      if(!adminVerified){ alert('You must verify as admin (enter password) to perform this action.'); return; }
      const t = ev.target;
      const row = t.closest('tr[data-id]');
      if(!row) return;
      const id = row.getAttribute('data-id');

      if(t.classList.contains('toggleBtn')){ t.classList.toggle('checked'); return; }
      if(t.classList.contains('deleteRowBtn')){
        if(!confirm('Delete staff record permanently?')) return;
        try{ await db.collection('staff').doc(id).delete(); await loadStaff(); await loadCounts(); alert('Deleted'); }catch(err){ alert('Delete failed: '+(err.message||err)); }
        return;
      }
      if(t.classList.contains('saveRowBtn')){
        try{
          const role = row.querySelector('.roleSel').value;
          const mainClass = row.querySelector('.mainClassInput').value;
          const active = row.querySelector('.toggleBtn').classList.contains('checked');
          const ref = db.collection('staff').doc(id);
          const beforeSnap = await ref.get();
          const before = beforeSnap.exists ? beforeSnap.data() : null;
          await ref.set({ role, mainClass, active, updated: new Date().toISOString() }, { merge:true });
          if(before && before.role !== role){
            const msg = `${before.name || before.email}: Umepewa role ya "${role}".`;
            await db.collection('notifications').add({ to: before.email||'', msg, createdAt: new Date().toISOString() });
          }
          alert('Saved');
          await loadStaff(); await loadCounts();
        }catch(err){ alert('Save failed: '+(err.message||err)); }
      }
    });

    // Save all
    saveAllStaffBtn.addEventListener('click', async ()=> {
      if(!adminVerified){ alert('Verify as admin first.'); return; }
      const rows = Array.from(staffTable.querySelectorAll('tr[data-id]'));
      if(rows.length===0) return alert('No rows to save');
      if(!confirm('Apply changes for all visible staff rows?')) return;
      try{
        const batch = db.batch();
        const roleChanges = [];
        rows.forEach(r=>{
          const id = r.getAttribute('data-id');
          const role = r.querySelector('.roleSel').value;
          const mainClass = r.querySelector('.mainClassInput').value;
          const active = r.querySelector('.toggleBtn').classList.contains('checked');
          const ref = db.collection('staff').doc(id);
          batch.set(ref, { role, mainClass, active, updated: new Date().toISOString() }, { merge:true });
          const before = staffList.find(s=>s.id===id);
          if(before && before.role !== role) roleChanges.push({ before, newRole: role });
        });
        await batch.commit();
        for(const rc of roleChanges){
          const msg = `${rc.before.name || rc.before.email}: Umepewa role ya "${rc.newRole}" kwenye UKSS.`;
          await db.collection('notifications').add({ to: rc.before.email||'', msg, createdAt: new Date().toISOString() });
        }
        alert('All saved');
        await loadStaff(); await loadCounts();
      }catch(err){ alert('Batch save failed: ' + (err.message||err)); }
    });

    // pending load & apply
    async function loadPending(){
      try{
        const snap = await db.collection('staff').where('role','==','').get();
        if(snap.empty){ pendingTable.innerHTML = '<tr><td colspan="6" class="muted">No pending staff.</td></tr>'; return; }
        pendingTable.innerHTML = snap.docs.map(d=> {
          const s = d.data();
          return `<tr data-id="${d.id}"><td>${escapeHtml(s.name||'')}</td><td>${escapeHtml(s.email||'')}</td><td>${escapeHtml(s.role||'')}</td><td><select class="pendingNewRole"><option>Admin</option><option>Headmaster</option><option>Academic</option><option>Class Teacher</option></select></td><td><input type="checkbox" class="pendingActive" /></td><td><button class="applyPending btn">Apply</button></td></tr>`;
        }).join('');
      }catch(err){ console.error('loadPending', err); pendingTable.innerHTML = `<tr><td colspan="6" class="danger">Error: ${escapeHtml(err.message||err)}</td></tr>`; }
    }

    pendingTable.addEventListener('click', async (ev)=>{
      if(!adminVerified){ alert('Verify as admin first.'); return; }
      const t = ev.target; const row = t.closest('tr[data-id]'); if(!row) return;
      const id = row.getAttribute('data-id');
      if(t.classList.contains('applyPending')){
        const newRole = row.querySelector('.pendingNewRole').value;
        const setActive = row.querySelector('.pendingActive').checked;
        try{ await db.collection('staff').doc(id).set({ role: newRole, active: setActive, updated: new Date().toISOString() }, { merge:true }); await loadPending(); await loadStaff(); alert('Applied'); }catch(err){ alert('Apply failed: ' + (err.message||err)); }
      }
    });

    // settings
    async function loadSettingsSafe(){
      try{
        const doc = await db.collection('settings').doc('global').get();
        if(doc.exists){
          const d = doc.data();
          setSchoolName.value = d.schoolName || '';
          setAcademicYear.value = d.academicYear || '';
          setSmsProvider.value = d.smsProvider || '';
          setGradingNote.value = d.gradingNote || '';
          if(d.examPeriod){ examStart.value = d.examPeriod.start || ''; examEnd.value = d.examPeriod.end || ''; updateExamCountdown(); }
        }
      }catch(err){ console.error('loadSettingsSafe', err); }
    }
    saveSettingsBtn.addEventListener('click', async ()=>{
      if(!adminVerified){ alert('Verify as admin first.'); return; }
      const payload = { schoolName:setSchoolName.value.trim(), academicYear:setAcademicYear.value.trim(), smsProvider:setSmsProvider.value.trim(), gradingNote:setGradingNote.value.trim(), updated: new Date().toISOString() };
      try{ await db.collection('settings').doc('global').set(payload, { merge:true }); settingsStatus.textContent='Saved'; setTimeout(()=>settingsStatus.textContent='',2000); }catch(err){ alert('Save failed: '+(err.message||err)); }
    });

    // exam
    saveExamBtn.addEventListener('click', async ()=>{
      if(!adminVerified){ alert('Verify as admin first.'); return; }
      const s = examStart.value; const e = examEnd.value;
      if(!s||!e){ alert('Weka start na end'); return; }
      try{ await db.collection('settings').doc('global').set({ examPeriod:{start:s,end:e}, updated: new Date().toISOString() }, { merge:true }); updateExamCountdown(); alert('Saved'); }catch(err){ alert('Save failed: ' + (err.message||err)); }
    });
    clearExamBtn.addEventListener('click', async ()=> {
      if(!adminVerified){ alert('Verify as admin first.'); return; }
      if(!confirm('Futa exam period?')) return;
      try{ await db.collection('settings').doc('global').set({ examPeriod: firebase.firestore.FieldValue.delete(), updated: new Date().toISOString() }, { merge:true }); examStart.value=''; examEnd.value=''; updateExamCountdown(); alert('Cleared'); }catch(err){ alert('Clear failed: ' + (err.message||err)); }
    });
    function updateExamCountdown(){ const s = examStart.value; const e = examEnd.value; if(!s||!e){ examCountdown.textContent='‚Äî'; return; } const end = new Date(e+'T23:59:59'); const now = new Date(); const diff = end-now; if(diff<0){ examCountdown.textContent='Ended'; return; } const days=Math.ceil(diff/(1000*60*60*24)); examCountdown.textContent = days + ' day' + (days>1?'s':'') + ' left'; }

    // logs
    async function loadNotifications(){ try{ const snap = await db.collection('notifications').orderBy('createdAt','desc').limit(50).get(); notificationsList = snap.docs.map(d=>({ id:d.id, ...d.data() })); }catch(err){ console.error('loadNotifications', err); notificationsList = []; } }
    openLogsBtn.addEventListener('click', async ()=> { await loadNotifications(); const msgs = notificationsList.map(n=> `${n.createdAt||''} ‚Üí ${n.to||''}: ${n.msg||''}`).join('\n\n'); alert(msgs||'No recent notifications'); });

    // util
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    // auth listener: hide admin area until verified. We allow reading settings preview but adminArea remains hidden
    auth.onAuthStateChanged(async (u)=>{
      adminVerified = false;
      if(u){
        signedInBadge.textContent = 'Signed in (not verified)';
        await loadSettingsSafe();
        updateExamCountdown();
        hideAdminArea();
      } else {
        signedInBadge.textContent = 'Not signed in';
        hideAdminArea();
      }
    });

    // initial
    (async ()=>{ await loadSettingsSafe(); updateExamCountdown(); hideAdminArea(); })();

    // prevent accidental navigation if admin link was anchor ‚Äî ensured earlier
  })();
  </script>
</body>
</html>







