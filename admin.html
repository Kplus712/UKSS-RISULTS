<!-- Save as admin.html (FULL single-file) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS ‚Äî Admin</title>
  <meta name="theme-color" content="#0b1320" />
  <style>
    /* Minimal styles (keeps your existing look but self-contained) */
    :root{
      --bg:#071427; --panel:#0b1724; --muted:#9fb0c6; --accent:#bfa034;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#07111a,#071427);color:#e6eef6;font-size:14px}
    .app{display:flex;min-height:100vh}
    aside.sidebar{width:220px;background:linear-gradient(180deg,#071427,#061025);padding:18px;border-right:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:16px}
    .brand-badge{background:var(--accent);color:#071225;padding:8px;border-radius:8px;font-weight:800}
    .brand-title{font-weight:800}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{color:var(--muted);text-decoration:none;padding:8px;border-radius:8px}
    .nav a.active{background:rgba(191,160,52,0.12);color:var(--accent);font-weight:700}
    main.main{flex:1;padding:18px;overflow:auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
    .small{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .field{flex:1;min-width:180px}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
    input.input, textarea.textarea, select{width:100%;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit}
    .btn{background:var(--accent);color:#071225;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    table.table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{font-size:13px;color:var(--muted);text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)}
    tbody td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .muted{color:var(--muted)}
    .danger{color:#ff9b9b}
    /* compact modal */
    .admin-modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:9999}
    .admin-modal-backdrop.active{display:flex}
    .admin-modal{width:420px;background:linear-gradient(180deg,#071427,#061025);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.06)}
    .error{color:#ff9b9b;margin-top:8px}
    /* small counts */
    .counts{display:flex;gap:10px;margin-top:10px}
    .count-box{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);min-width:90px;text-align:center;background:rgba(255,255,255,0.01)}
    /* responsive */
    @media(max-width:900px){ aside.sidebar{display:none} body{padding:8px} }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">UK</div>
      <div>
        <div class="brand-title">UKSS</div>
        <div class="brand-sub small">Results Management</div>
      </div>
    </div>

    <nav class="nav">
      <a href="marks.html">üè† Marks</a>
      <a href="results.html">üìÑ Results</a>
      <a href="ranking.html">üèÜ Ranking</a>
      <a href="behaviour.html">üß≠ Behaviour</a>
      <a href="sms.html">üì® SMS</a>
      <a href="sms_logs.html">üßæ SMS Logs</a>
      <a href="#" class="active">üîê Admin</a>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <div>
        <h2>üîê Admin Control Center</h2>
        <p class="small">Full control kwa system owner: staff roles, system settings, logs na approvals za access.</p>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="signedInBadge" class="small muted">Not signed in</div>
        <button id="openAdminGateBtn" class="btn btn-ghost">Admin Login</button>
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </header>

    <!-- Account -->
    <section class="card">
      <h3>Your Account</h3>
      <p class="small">Hapa unaona taarifa zako na role uliyopewa. Kazi za admin zipo chini.</p>

      <div class="row">
        <div class="field">
          <label class="label">Name</label>
          <input id="meName" class="input" type="text" disabled />
        </div>
        <div class="field">
          <label class="label">Email</label>
          <input id="meEmail" class="input" type="text" disabled />
        </div>
        <div class="field">
          <label class="label">Role</label>
          <input id="meRole" class="input" type="text" disabled />
        </div>
        <div class="field">
          <label class="label">Main Class</label>
          <input id="meClass" class="input" type="text" disabled />
        </div>
      </div>
      <p id="roleWarning" class="small danger" style="margin-top:8px;display:none"></p>
    </section>

    <!-- Staff -->
    <section class="card">
      <h3>1. Staff Management</h3>
      <p class="small">Badili roles, class na status ya staff. ‚ÄúActive‚Äù ikizimwa, user hawezi kutumia mfumo.</p>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <input id="staffSearch" placeholder="Search name/email..." style="width:320px" />
        <div>
          <button id="reloadStaffBtn" class="btn btn-ghost">Reload</button>
          <button id="saveAllStaffBtn" class="btn">Save All</button>
        </div>
      </div>

      <div style="margin-top:8px;overflow:auto;max-height:260px">
        <table class="table" id="staffTable">
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Main Class</th><th>Active</th><th>Updated</th><th></th></tr></thead>
          <tbody><tr><td colspan="7" class="muted">Loading staff...</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Pending -->
    <section class="card">
      <h3>2. Access Control & Approvals</h3>
      <p class="small">Staff wapya au wasio na role/active wataonekana hapa. Wape role sahihi na uwasha ‚ÄúActive‚Äù.</p>
      <div style="margin-top:8px;overflow:auto;max-height:160px">
        <table class="table" id="pendingTable">
          <thead><tr><th>Name</th><th>Email</th><th>Current Role</th><th>New Role</th><th>Set Active</th><th>Apply</th></tr></thead>
          <tbody><tr><td colspan="6" class="muted">No pending staff.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Settings -->
    <section class="card">
      <h3>3. System Settings</h3>
      <p class="small">Taarifa za shule na baadhi ya settings za mfumo. Stored at <code>settings/global</code>.</p>

      <div class="row">
        <div class="field"><label class="label">School Name</label><input id="setSchoolName" class="input" placeholder="eg. Mambosasa Secondary School" /></div>
        <div class="field"><label class="label">Academic Year</label><input id="setAcademicYear" class="input" placeholder="eg. 2025" /></div>
        <div class="field"><label class="label">SMS Provider</label><input id="setSmsProvider" class="input" placeholder="Beem Africa" /></div>
      </div>

      <div style="margin-top:10px">
        <div class="label">Grading Note</div>
        <textarea id="setGradingNote" class="textarea" rows="3" placeholder="eg. A: 75‚Äì100, B: 65‚Äì74..."></textarea>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="saveSettingsBtn" class="btn">Save Settings</button>
        <span id="settingsStatus" class="small muted"></span>
      </div>
    </section>

    <!-- Exam & Logs -->
    <section class="card" style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <h3>Exam Period</h3>
        <p class="small">Set exam start & end. System will show countdown where needed.</p>
        <div class="row">
          <div class="field"><label class="label">Start</label><input id="examStart" class="input" type="date" /></div>
          <div class="field"><label class="label">End</label><input id="examEnd" class="input" type="date" /></div>
          <div style="display:flex;flex-direction:column;justify-content:center">
            <div class="small muted">Days left</div>
            <div id="examCountdown" class="countdown" style="font-weight:800;color:var(--accent)">‚Äî</div>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button id="saveExamBtn" class="btn">Save Period</button>
          <button id="clearExamBtn" class="btn btn-ghost">Clear</button>
        </div>
      </div>

      <div style="width:320px">
        <h3>Logs & Overview</h3>
        <p class="small">Counts & quick links.</p>
        <div class="counts">
          <div class="count-box"><div class="small">Staff</div><div id="staffCount">‚Äî</div></div>
          <div class="count-box"><div class="small">Students</div><div id="studentsCount">‚Äî</div></div>
          <div class="count-box"><div class="small">Notifications</div><div id="notifCount">‚Äî</div></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-direction:column">
          <button id="openLogsBtn" class="btn btn-ghost">Open Logs</button>
          <a href="results.html" class="btn btn-ghost">Open Results Page</a>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Compact admin sign-in modal -->
<div id="adminModal" class="admin-modal-backdrop" aria-hidden="true">
  <div class="admin-modal" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
    <h3 id="adminModalTitle">Admin sign-in</h3>
    <p class="small muted">Enter email & password (or leave email blank to reauthenticate current user).</p>

    <div style="margin-top:8px"><input id="modalEmail" type="text" placeholder="Email (leave if reauth)" /></div>
    <div style="margin-top:8px"><input id="modalPassword" type="password" placeholder="Password" /></div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="modalCancel" class="btn btn-ghost">Cancel</button>
      <button id="modalSubmit" class="btn">Sign in</button>
    </div>

    <div id="modalError" class="error" aria-live="polite" style="min-height:18px"></div>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ========= CONFIG - replace if you initialize elsewhere ========= */
const firebaseConfig = {
  apiKey: "AIzaSyA8QMDOD-bUXpElehkg2BlJhKE1_cbvKek",
  authDomain: "school-results-management.firebaseapp.com",
  databaseURL: "https://school-results-management-default-rtdb.firebaseio.com",
  projectId: "school-results-management",
  storageBucket: "school-results-management.firebasestorage.app",
  messagingSenderId: "755154296958",
  appId: "1:755154296958:web:e4c5f9bc0e6cce3e9cf82f",
  measurementId: "G-MDN4Q3C22J"
};

if(!window.firebase) throw new Error('Firebase SDK not loaded.');
if(!firebase.apps || !firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();
/* ============================================================== */

(function(){
  // UI refs
  const openAdminGateBtn = document.getElementById('openAdminGateBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const signedInBadge = document.getElementById('signedInBadge');

  const meName = document.getElementById('meName');
  const meEmail = document.getElementById('meEmail');
  const meRole = document.getElementById('meRole');
  const meClass = document.getElementById('meClass');
  const roleWarning = document.getElementById('roleWarning');

  // staff
  const staffTable = document.getElementById('staffTable').querySelector('tbody');
  const staffSearch = document.getElementById('staffSearch');
  const reloadStaffBtn = document.getElementById('reloadStaffBtn');
  const saveAllStaffBtn = document.getElementById('saveAllStaffBtn');

  // pending
  const pendingTable = document.getElementById('pendingTable').querySelector('tbody');

  // settings
  const setSchoolName = document.getElementById('setSchoolName');
  const setAcademicYear = document.getElementById('setAcademicYear');
  const setSmsProvider = document.getElementById('setSmsProvider');
  const setGradingNote = document.getElementById('setGradingNote');
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');
  const settingsStatus = document.getElementById('settingsStatus');

  // exam
  const examStart = document.getElementById('examStart');
  const examEnd = document.getElementById('examEnd');
  const examCountdown = document.getElementById('examCountdown');
  const saveExamBtn = document.getElementById('saveExamBtn');
  const clearExamBtn = document.getElementById('clearExamBtn');

  // logs / counts
  const staffCountEl = document.getElementById('staffCount');
  const studentsCountEl = document.getElementById('studentsCount');
  const notifCountEl = document.getElementById('notifCount');
  const openLogsBtn = document.getElementById('openLogsBtn');

  // modal
  const adminModal = document.getElementById('adminModal');
  const modalEmail = document.getElementById('modalEmail');
  const modalPassword = document.getElementById('modalPassword');
  const modalCancel = document.getElementById('modalCancel');
  const modalSubmit = document.getElementById('modalSubmit');
  const modalError = document.getElementById('modalError');

  // local state
  let staffList = [];
  let studentsList = [];
  let notificationsList = [];
  let currentStaffRecord = null;

  // helpers
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  function toast(el, txt){ if(!el) return; el.textContent = txt; setTimeout(()=> el.textContent = '', 2000); }
  function showModal(errMsg){
    modalError.textContent = errMsg || '';
    adminModal.classList.add('active'); adminModal.style.display = 'flex';
    modalPassword.focus();
  }
  function hideModal(){
    adminModal.classList.remove('active'); adminErrorClear(); adminModal.style.display = 'none';
    modalPassword.value = '';
  }
  function adminErrorClear(){ modalError.textContent = ''; }

  // attach modal behaviour
  openAdminGateBtn.addEventListener('click', ()=> {
    modalEmail.value = auth.currentUser ? (auth.currentUser.email || '') : '';
    modalPassword.value = '';
    modalError.textContent = '';
    adminModal.classList.add('active');
    adminModal.style.display = 'flex';
    modalPassword.focus();
  });
  modalCancel.addEventListener('click', ()=> { adminModal.classList.remove('active'); adminModal.style.display = 'none'; modalError.textContent = ''; });

  // close modal on backdrop click
  adminModal.addEventListener('click', (e)=> { if(e.target === adminModal){ adminModal.classList.remove('active'); adminModal.style.display = 'none'; } });

  // LOGOUT
  logoutBtn.addEventListener('click', async ()=>{
    try{ await auth.signOut(); resetUiForSignedOut(); alert('Signed out'); }catch(e){ console.error(e); alert('Sign out failed'); }
  });

  // Sign-in / reauth flow
  modalSubmit.addEventListener('click', async ()=>{
    modalError.textContent = '';
    modalSubmit.disabled = true;
    const email = (modalEmail.value || '').trim();
    const pw = modalPassword.value || '';
    if(!pw){ modalError.textContent = 'Ingiza password.'; modalSubmit.disabled = false; return; }

    try{
      let user;
      // if logged in & email matches => reauthenticate; else sign in
      if(auth.currentUser && (!email || auth.currentUser.email === email)){
        const cred = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, pw);
        await auth.currentUser.reauthenticateWithCredential(cred);
        user = auth.currentUser;
      } else {
        const res = await auth.signInWithEmailAndPassword(email, pw);
        user = res.user;
      }

      // check staff collection role
      const allowed = await checkStaffIsAdmin(user);
      if(!allowed){
        modalError.textContent = 'Account hii hauna ruhusa ya Admin.';
        try{ await auth.signOut(); } catch(e){}
        modalSubmit.disabled = false;
        return;
      }

      // success -> update UI
      populateAccountInfo(user, currentStaffRecord);
      await loadCounts();
      await loadStaff(); // pre-load staff
      adminModal.classList.remove('active'); adminModal.style.display = 'none';
    }catch(err){
      console.error('Sign-in error', err);
      if(err && err.message && err.message.includes('API key not valid')) modalError.textContent = 'API key invalid ‚Äî hakikisha firebaseConfig ni sahihi.';
      else if(err && err.code === 'auth/wrong-password') modalError.textContent = 'Password sio sahihi.';
      else modalError.textContent = err.message || 'Login failed';
    } finally {
      modalSubmit.disabled = false;
      modalPassword.value = '';
    }
  });

  // check staff doc & role
  async function checkStaffIsAdmin(user){
    if(!user) return false;
    currentStaffRecord = null;
    try{
      const doc = await db.collection('staff').doc(user.uid).get();
      if(doc.exists) currentStaffRecord = { id: doc.id, ...doc.data() };
      else {
        const q = await db.collection('staff').where('email', '==', user.email).limit(1).get();
        if(!q.empty) currentStaffRecord = { id: q.docs[0].id, ...q.docs[0].data() };
      }
      if(!currentStaffRecord) return false;
      return (currentStaffRecord.role || '').toLowerCase().includes('admin');
    }catch(err){ console.error('checkStaffIsAdmin', err); throw err; }
  }

  // populate account UI
  function populateAccountInfo(user, staffRec){
    meName.value = staffRec && staffRec.name || user.displayName || '';
    meEmail.value = user.email || user.uid || '';
    meRole.value = staffRec && staffRec.role || '';
    meClass.value = staffRec && staffRec.mainClass || '';
    signedInBadge.textContent = 'Signed in: ' + (user.email || user.uid);
    roleWarning.style.display = (staffRec && staffRec.role && staffRec.role.toLowerCase().includes('admin')) ? 'none' : 'block';
  }
  function resetUiForSignedOut(){
    meName.value = ''; meEmail.value = ''; meRole.value = ''; meClass.value = '';
    signedInBadge.textContent = 'Not signed in';
    staffTable.innerHTML = '<tr><td colspan="7" class="muted">Please sign in as Admin to manage staff.</td></tr>';
    staffCountEl.textContent = '‚Äî'; studentsCountEl.textContent = '‚Äî'; notifCountEl.textContent = '‚Äî';
  }

  // LOAD COUNTS
  async function loadCounts(){
    try{
      // staff count
      const staffSnap = await db.collection('staff').get();
      staffCountEl.textContent = staffSnap.size;
      // students
      const stuSnap = await db.collection('students').get();
      studentsCountEl.textContent = stuSnap.size;
      // notifications
      const noteSnap = await db.collection('notifications').get();
      notifCountEl.textContent = noteSnap.size;
    }catch(err){
      console.error('loadCounts error', err);
      // show permissive messages
      if(err && err.code === 'permission-denied'){
        staffCountEl.textContent = 'denied'; studentsCountEl.textContent = 'denied'; notifCountEl.textContent = 'denied';
      } else { staffCountEl.textContent = 'err'; studentsCountEl.textContent = 'err'; notifCountEl.textContent = 'err'; }
    }
  }

  // STAFF: load, render, save
  async function loadStaff(){
    staffTable.innerHTML = '<tr><td colspan="7" class="muted">Loading staff...</td></tr>';
    try{
      const snap = await db.collection('staff').orderBy('name','asc').get();
      staffList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderStaff(staffList);
    }catch(err){
      console.error('loadStaff', err);
      staffTable.innerHTML = `<tr><td colspan="7" class="danger">Failed to load staff: ${esc(err.message||err)}</td></tr>`;
    }
  }

  function renderStaff(list){
    if(!list || list.length === 0){ staffTable.innerHTML = '<tr><td colspan="7" class="muted">No staff found.</td></tr>'; return; }
    const rows = list.map(s => {
      const active = s.active ? 'checked' : '';
      return `<tr data-id="${esc(s.id)}">
        <td><strong>${esc(s.name)}</strong></td>
        <td>${esc(s.email)}</td>
        <td>
          <select class="roleSel">
            <option ${s.role==='Admin'?'selected':''}>Admin</option>
            <option ${s.role==='Headmaster'?'selected':''}>Headmaster</option>
            <option ${s.role==='Academic'?'selected':''}>Academic</option>
            <option ${s.role==='Class Teacher'?'selected':''}>Class Teacher</option>
          </select>
        </td>
        <td><input class="mainClassInput" value="${esc(s.mainClass||'')}" /></td>
        <td><button class="toggleBtn ${active}"></button></td>
        <td>${esc(s.updated||'')}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-ghost saveRowBtn" data-id="${esc(s.id)}" style="padding:6px 8px">Save</button>
          <button class="btn btn-ghost deleteRowBtn" data-id="${esc(s.id)}" style="padding:6px 8px">Delete</button>
        </td>
      </tr>`;
    }).join('');
    staffTable.innerHTML = rows;
  }

  // Staff table events (delegation)
  staffTable.addEventListener('click', async (ev)=>{
    const t = ev.target;
    const row = t.closest('tr[data-id]');
    if(!row) return;
    const id = row.getAttribute('data-id');

    if(t.classList.contains('toggleBtn')){
      t.classList.toggle('checked');
      return;
    }
    if(t.classList.contains('deleteRowBtn')){
      if(!confirm('Delete staff record permanently?')) return;
      try{
        await db.collection('staff').doc(id).delete();
        await loadStaff(); await loadCounts();
        toast(settingsStatus, 'Deleted');
      }catch(err){ alert('Delete failed: ' + (err.message||err)); }
      return;
    }
    if(t.classList.contains('saveRowBtn')){
      try{
        const role = row.querySelector('.roleSel').value;
        const mainClass = row.querySelector('.mainClassInput').value;
        const active = row.querySelector('.toggleBtn').classList.contains('checked');
        const ref = db.collection('staff').doc(id);
        const beforeSnap = await ref.get();
        const before = beforeSnap.exists ? beforeSnap.data() : null;
        await ref.set({ role, mainClass, active, updated: new Date().toISOString() }, { merge: true });
        if(before && before.role !== role){
          const msg = `${before.name || before.email}: Umepewa role ya "${role}" kwenye mfumo wa UKSS.`;
          await db.collection('notifications').add({ to: before.email||'', msg, createdAt: new Date().toISOString() });
        }
        toast(settingsStatus, 'Saved');
        await loadStaff(); await loadCounts();
      }catch(err){ console.error('saveRow', err); alert('Save failed: ' + (err.message||err)); }
    }
  });

  // Save all staff (batch)
  saveAllStaffBtn.addEventListener('click', async ()=>{
    const rows = Array.from(staffTable.querySelectorAll('tr[data-id]'));
    if(rows.length === 0) return toast(settingsStatus, 'No rows to save');
    if(!confirm('Apply changes for all visible staff rows?')) return;
    try{
      const batch = db.batch();
      const roleChanges = [];
      rows.forEach(r=>{
        const id = r.getAttribute('data-id');
        const role = r.querySelector('.roleSel').value;
        const mainClass = r.querySelector('.mainClassInput').value;
        const active = r.querySelector('.toggleBtn').classList.contains('checked');
        const ref = db.collection('staff').doc(id);
        batch.set(ref, { role, mainClass, active, updated: new Date().toISOString() }, { merge:true });
        const before = staffList.find(s=>s.id===id);
        if(before && before.role !== role) roleChanges.push({ before, newRole: role });
      });
      await batch.commit();
      // create notifications for role changes
      for(const rc of roleChanges){
        const msg = `${rc.before.name || rc.before.email}: Umepewa role ya "${rc.newRole}" kwenye UKSS.`;
        await db.collection('notifications').add({ to: rc.before.email||'', msg, createdAt: new Date().toISOString() });
      }
      toast(settingsStatus, 'All saved');
      await loadStaff(); await loadCounts();
    }catch(err){ console.error('saveAll', err); alert('Batch save failed: ' + (err.message||err)); }
  });

  // Search staff client-side
  staffSearch.addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    if(!q) return renderStaff(staffList);
    renderStaff(staffList.filter(s => (s.name||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q)));
  });

  // PENDING: simple implementation: find staff without role or active=false
  async function loadPending(){
    try{
      const snap = await db.collection('staff').where('role','==','').get(); // example search - adjust as needed
      if(snap.empty){ pendingTable.innerHTML = '<tr><td colspan="6" class="muted">No pending staff.</td></tr>'; return; }
      const rows = snap.docs.map(d=>{
        const s = d.data();
        return `<tr data-id="${d.id}"><td>${esc(s.name)}</td><td>${esc(s.email)}</td><td>${esc(s.role||'')}</td><td>
          <select class="pendingNewRole"><option>Admin</option><option>Headmaster</option><option>Academic</option><option>Class Teacher</option></select>
        </td><td><input type="checkbox" class="pendingActive" /></td><td><button class="applyPending btn">Apply</button></td></tr>`;
      }).join('');
      pendingTable.innerHTML = rows;
    }catch(err){ console.error('loadPending', err); pendingTable.innerHTML = `<tr><td colspan="6" class="danger">Error loading pending: ${esc(err.message||err)}</td></tr>`; }
  }

  // pending apply (delegation)
  pendingTable.addEventListener('click', async (ev)=>{
    const t = ev.target;
    const row = t.closest('tr[data-id]');
    if(!row) return;
    const id = row.getAttribute('data-id');
    if(t.classList.contains('applyPending')){
      const newRole = row.querySelector('.pendingNewRole').value;
      const setActive = row.querySelector('.pendingActive').checked;
      try{
        await db.collection('staff').doc(id).set({ role: newRole, active: setActive, updated: new Date().toISOString() }, { merge:true });
        await loadPending(); await loadStaff();
        toast(settingsStatus, 'Applied');
      }catch(err){ console.error('applyPending', err); alert('Apply failed: ' + (err.message||err)); }
    }
  });

  // SETTINGS: load + save
  async function loadSettings(){
    try{
      const doc = await db.collection('settings').doc('global').get();
      if(doc.exists){
        const d = doc.data();
        setSchoolName.value = d.schoolName || '';
        setAcademicYear.value = d.academicYear || '';
        setSmsProvider.value = d.smsProvider || '';
        setGradingNote.value = d.gradingNote || '';
        if(d.examPeriod){
          examStart.value = d.examPeriod.start || '';
          examEnd.value = d.examPeriod.end || '';
        }
      } else {
        setSchoolName.value=''; setAcademicYear.value=''; setSmsProvider.value=''; setGradingNote.value='';
      }
    }catch(err){ console.error('loadSettings', err); }
  }

  saveSettingsBtn.addEventListener('click', async ()=>{
    const payload = {
      schoolName: setSchoolName.value.trim(),
      academicYear: setAcademicYear.value.trim(),
      smsProvider: setSmsProvider.value.trim(),
      gradingNote: setGradingNote.value.trim(),
      updated: new Date().toISOString()
    };
    try{
      await db.collection('settings').doc('global').set(payload, { merge:true });
      toast(settingsStatus, 'Saved');
    }catch(err){ console.error('saveSettings', err); settingsStatus.textContent = 'Save failed'; }
  });

  // EXAM period
  saveExamBtn.addEventListener('click', async ()=>{
    const s = examStart.value; const e = examEnd.value;
    if(!s || !e){ alert('Weka start na end'); return; }
    try{
      await db.collection('settings').doc('global').set({ examPeriod: { start: s, end: e }, updated: new Date().toISOString() }, { merge:true });
      updateExamCountdown();
      toast(settingsStatus, 'Exam period saved');
    }catch(err){ console.error('saveExam', err); alert('Save failed: ' + (err.message||err)); }
  });

  clearExamBtn.addEventListener('click', async ()=>{
    if(!confirm('Futa exam period?')) return;
    try{
      await db.collection('settings').doc('global').set({ examPeriod: firebase.firestore.FieldValue.delete(), updated: new Date().toISOString() }, { merge:true });
      examStart.value = ''; examEnd.value = ''; updateExamCountdown();
      toast(settingsStatus, 'Cleared');
    }catch(err){ console.error('clearExam', err); alert('Clear failed: ' + (err.message||err)); }
  });

  function updateExamCountdown(){
    const s = examStart.value; const e = examEnd.value;
    if(!s || !e){ examCountdown.textContent = '‚Äî'; return; }
    const end = new Date(e + 'T23:59:59'); const now = new Date();
    const diff = end - now;
    if(diff < 0){ examCountdown.textContent = 'Ended'; return; }
    const days = Math.ceil(diff / (1000*60*60*24));
    examCountdown.textContent = days + ' day' + (days>1?'s':'') + ' left';
  }

  // LOAD students list (for counts / deletes)
  async function loadStudents(){
    try{
      const snap = await db.collection('students').orderBy('index','asc').get();
      studentsList = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
    }catch(err){ console.error('loadStudents', err); studentsList = []; }
  }

  // LOGS: load notifications
  async function loadNotifications(){
    try{
      const snap = await db.collection('notifications').orderBy('createdAt','desc').limit(50).get();
      notificationsList = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
    }catch(err){ console.error('loadNotifications', err); notificationsList = []; }
  }

  // opening logs button
  openLogsBtn.addEventListener('click', async ()=>{
    await loadNotifications();
    const msgs = notificationsList.map(n => `${n.createdAt || ''} ‚Üí ${n.to || ''}: ${n.msg || ''}`).join('\n\n');
    alert(msgs || 'No recent notifications');
  });

  // initial auth listener: populate if already logged-in
  auth.onAuthStateChanged(async (u)=>{
    if(u){
      try{
        const ok = await checkStaffIsAdmin(u);
        if(!ok){
          resetUiForSignedOut();
          return;
        }
        populateAccountInfo(u, currentStaffRecord);
        await loadCounts();
        // do not auto-open admin panel, just pre-load staff
        await loadStaff();
        await loadPending();
      }catch(err){
        console.error('onAuthStateChanged handling error', err);
      }
    } else {
      resetUiForSignedOut();
    }
  });

  // initial load for settings
  (async ()=>{ await loadSettings(); updateExamCountdown(); })();

  // expose quick helper if needed
  window.ukssReloadStaff = loadStaff;
})();
</script>
</body>
</html>






