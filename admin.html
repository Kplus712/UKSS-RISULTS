<!doctype html>
<html lang="sw">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UKSS ‚Äî Admin Debug</title>
  <meta name="theme-color" content="#071427" />
  <style>
    :root{ --bg:#071427; --muted:#9fb0c6; --accent:#bfa034; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#07111a,#071427);color:#e6eef6;font-family:Inter,system-ui,Arial;padding:18px}
    .btn{background:var(--accent);color:#071225;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    input{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    .muted{color:var(--muted);font-size:13px}
    .debug{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-top:10px}
    .error{color:#ff9b9b}
    .counts{display:flex;gap:12px;margin-top:10px}
    .countBox{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);min-width:100px;text-align:center}
    .small{font-size:13px;color:var(--muted)}
    .inline{display:inline-block}
  </style>
</head>
<body>
  <h2>UKSS ‚Äî Admin (Debug)</h2>
  <p class="muted">Modal ndogo ya kuingia kwenye admin. Utaona status + counts za collections mara utakapothibitishwa.</p>

  <div style="margin-top:12px">
    <button id="openAdminBtn" class="btn ghost">üîê Open Admin Gate</button>
  </div>

  <!-- Compact modal -->
  <div id="backdrop" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);z-index:9999">
    <div style="width:420px;background:linear-gradient(180deg,#071427,#061025);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 18px 50px rgba(0,0,0,0.6);">
      <h3 style="margin:0 0 6px">Admin sign-in (debug)</h3>
      <div class="muted">Ingiza email + password zako za Firebase. Ikiwa ume-login tayari, weka email au acha na weka password tu (reauthenticate).</div>

      <div style="margin-top:8px">
        <input id="email" type="text" placeholder="Email (acha ikiwa ume-login)" style="width:100%"/>
      </div>
      <div style="margin-top:8px">
        <input id="password" type="password" placeholder="Password" style="width:100%"/>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="cancelBtn" class="btn ghost">Cancel</button>
        <button id="submitBtn" class="btn">Sign in</button>
      </div>

      <div id="gateError" style="margin-top:8px;min-height:18px;"></div>

      <div id="compactControls" style="display:none;margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong id="userLabel"></strong>
            <div class="small muted" id="userRole"></div>
          </div>
          <div class="small muted">Quick info</div>
        </div>

        <div class="counts">
          <div class="countBox"><div class="small">Staff</div><div id="staffCount">‚Äî</div></div>
          <div class="countBox"><div class="small">Students</div><div id="studentsCount">‚Äî</div></div>
          <div class="countBox"><div class="small">Notifications</div><div id="notifCount">‚Äî</div></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="openPanelBtn" class="btn ghost">Open Full Panel</button>
          <button id="makeTestNotif" class="btn ghost">Create Test Notice</button>
        </div>
      </div>

      <div id="adminPanel" style="display:none;margin-top:12px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);max-height:50vh;overflow:auto">
        <h4 style="margin:0 0 8px">Full Admin Panel (Debug)</h4>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="searchStaff" placeholder="Search staff..." style="flex:1"/>
          <button id="btnRefreshStaff" class="btn ghost">Refresh</button>
        </div>

        <div id="staffTableWrap" style="margin-top:8px">
          <table style="width:100%;border-collapse:collapse">
            <thead><tr style="color:var(--muted)"><th style="text-align:left">Name</th><th>Email</th><th>Role</th><th>Active</th></tr></thead>
            <tbody id="staffTbody"><tr><td colspan="4" class="muted">No data loaded.</td></tr></tbody>
          </table>
        </div>

        <div style="margin-top:12px">
          <h5 style="margin:0 0 6px">Debug status</h5>
          <pre id="debugStatus" class="debug" style="white-space:pre-wrap;max-height:180px;overflow:auto"></pre>
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // your firebase config (from you)
  const firebaseConfig = {
    apiKey: "AIzaSyA8QMDOD-bUXpElehkg2BlJhKE1_cbvKek",
    authDomain: "school-results-management.firebaseapp.com",
    databaseURL: "https://school-results-management-default-rtdb.firebaseio.com",
    projectId: "school-results-management",
    storageBucket: "school-results-management.firebasestorage.app",
    messagingSenderId: "755154296958",
    appId: "1:755154296958:web:e4c5f9bc0e6cce3e9cf82f",
    measurementId: "G-MDN4Q3C22J"
  };

  // initialize (if not already)
  if(!window.firebase) {
    const msg = 'Firebase SDK not loaded ‚Äî check network or SDK script tags.';
    alert(msg);
    throw new Error(msg);
  }
  if(!firebase.apps || !firebase.apps.length){
    firebase.initializeApp(firebaseConfig);
    console.log('Firebase initialized (debug).');
  } else {
    console.log('Firebase already initialized.');
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  // small helpers to write debug status
  const debugStatusEl = document.getElementById('debugStatus');
  function dbg(msg){
    const ts = (new Date()).toLocaleTimeString();
    const line = `[${ts}] ${msg}\n`;
    debugStatusEl.textContent = line + debugStatusEl.textContent;
    console.log(line.trim());
  }
  function showErrorUI(msg){
    const el = document.getElementById('gateError');
    el.innerHTML = `<span class="error">${msg}</span>`;
    dbg('ERROR: ' + msg);
  }

  // UI refs
  const openAdminBtn = document.getElementById('openAdminBtn');
  const backdrop = document.getElementById('backdrop');
  const emailIn = document.getElementById('email');
  const passwordIn = document.getElementById('password');
  const cancelBtn = document.getElementById('cancelBtn');
  const submitBtn = document.getElementById('submitBtn');
  const gateError = document.getElementById('gateError');

  const compactControls = document.getElementById('compactControls');
  const userLabel = document.getElementById('userLabel');
  const userRole = document.getElementById('userRole');
  const staffCountEl = document.getElementById('staffCount');
  const studentsCountEl = document.getElementById('studentsCount');
  const notifCountEl = document.getElementById('notifCount');
  const openPanelBtn = document.getElementById('openPanelBtn');
  const makeTestNotif = document.getElementById('makeTestNotif');

  const adminPanel = document.getElementById('adminPanel');
  const staffTbody = document.getElementById('staffTbody');
  const searchStaff = document.getElementById('searchStaff');
  const btnRefreshStaff = document.getElementById('btnRefreshStaff');

  // open modal
  openAdminBtn.addEventListener('click', ()=>{
    gateError.textContent = '';
    compactControls.style.display = 'none';
    adminPanel.style.display = 'none';
    const u = auth.currentUser;
    if(u && u.email) emailIn.value = u.email;
    backdrop.style.display = 'flex';
    passwordIn.focus();
    dbg('Admin gate opened.');
  });
  cancelBtn.addEventListener('click', ()=> { backdrop.style.display = 'none'; });

  // safe get count helper (returns {count, error})
  async function safeGetCollectionCount(col){
    try{
      dbg(`Querying count for collection "${col}" ...`);
      const snap = await db.collection(col).limit(1).get(); // fast check
      // we can't get server-side count with v8 without aggregation; approximate via get().size if small
      const all = await db.collection(col).get();
      dbg(`Collection "${col}" fetched, docs: ${all.size}`);
      return { count: all.size, error: null, docs: all.docs };
    }catch(err){
      dbg(`Error reading collection "${col}": ${err && err.message}`);
      return { count: 0, error: err, docs: [] };
    }
  }

  async function loadCountsAndShow(){
    // show working
    staffCountEl.textContent = '‚Ä¶'; studentsCountEl.textContent = '‚Ä¶'; notifCountEl.textContent = '‚Ä¶';
    // staff
    const staffRes = await safeGetCollectionCount('staff');
    if(staffRes.error){
      staffCountEl.textContent = 'err';
      showErrorUI(`Cannot read "staff": ${staffRes.error.message || staffRes.error}`);
    } else staffCountEl.textContent = staffRes.count;

    const stuRes = await safeGetCollectionCount('students');
    if(stuRes.error){
      studentsCountEl.textContent = 'err';
      dbg('students read error: ' + (stuRes.error.message||stuRes.error));
    } else studentsCountEl.textContent = stuRes.count;

    const notifRes = await safeGetCollectionCount('notifications');
    if(notifRes.error){
      notifCountEl.textContent = 'err';
      dbg('notifications read error: ' + (notifRes.error.message||notifRes.error));
    } else notifCountEl.textContent = notifRes.count;

    // render small sample of staff into table
    renderStaffSample(staffRes.docs || []);
  }

  function renderStaffSample(docs){
    if(!docs || docs.length===0){
      staffTbody.innerHTML = `<tr><td colspan="4" class="muted">No staff documents returned (collection empty or read blocked).</td></tr>`;
      return;
    }
    const rows = docs.map(d=>{
      const data = d.data();
      return `<tr><td>${escapeHtml(data.name||'')}</td><td>${escapeHtml(data.email||'')}</td><td>${escapeHtml(data.role||'')}</td><td>${data.active? 'Yes':'No'}</td></tr>`;
    }).join('');
    staffTbody.innerHTML = rows;
  }

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

  // sign in / reauth
  submitBtn.addEventListener('click', async ()=>{
    gateError.textContent = '';
    submitBtn.disabled = true;
    const email = (emailIn.value||'').trim();
    const pw = passwordIn.value || '';
    if(!pw){ showErrorUI('Ingiza password.'); submitBtn.disabled = false; return; }

    try{
      let user;
      if(auth.currentUser && auth.currentUser.email === email){
        dbg('Attempting reauthenticate for existing user: ' + (email || auth.currentUser.email));
        const cred = firebase.auth.EmailAuthProvider.credential(email || auth.currentUser.email, pw);
        await auth.currentUser.reauthenticateWithCredential(cred);
        user = auth.currentUser;
      } else {
        dbg('Signing in with email/password for: ' + email);
        const res = await auth.signInWithEmailAndPassword(email, pw);
        user = res.user;
      }

      dbg('Signed in user uid=' + (user && user.uid));
      // check admin
      const ok = await checkIsAdmin(user);
      if(!ok){
        showErrorUI('Account sasa imeingia lakini haina role ya Admin (staff doc not found or role wrong).');
        try{ await auth.signOut(); dbg('Signed out non-admin user.'); } catch(e){}
        return;
      }

      // success: show compact controls and counts
      userLabel.textContent = user.displayName || user.email || user.uid;
      userRole.textContent = 'Role: ' + (currentStaffRecord && currentStaffRecord.role || 'unknown');
      compactControls.style.display = '';
      dbg('User is Admin ‚Äî fetching counts and sample data...');
      await loadCountsAndShow();
      // keep modal open so admin can act
    }catch(err){
      console.error('Sign-in error', err);
      const friendly = (err && err.code === 'auth/wrong-password') ? 'Password sio sahihi.' : (err && err.message) ? err.message : 'Login failed';
      showErrorUI(friendly);
      dbg('Sign-in exception: ' + (err && err.message));
    } finally {
      submitBtn.disabled = false;
      passwordIn.value = '';
    }
  });

  // check staff doc & role
  async function checkIsAdmin(user){
    if(!user) return false;
    currentStaffRecord = null;
    try{
      dbg('Checking staff record for uid=' + user.uid);
      const doc = await db.collection('staff').doc(user.uid).get();
      if(doc.exists){
        currentStaffRecord = { id: doc.id, ...doc.data() };
        dbg('Found staff doc by uid: ' + JSON.stringify(currentStaffRecord));
      } else {
        dbg('No staff doc by uid, trying by email...');
        const q = await db.collection('staff').where('email','==', user.email).limit(1).get();
        if(!q.empty){ currentStaffRecord = { id: q.docs[0].id, ...q.docs[0].data() }; dbg('Found staff doc by email: ' + JSON.stringify(currentStaffRecord)); }
      }
      if(!currentStaffRecord){
        dbg('No staff record found for user. (Make sure collection "staff" has doc keyed by uid or doc with email field.)');
        return false;
      }
      const r = (currentStaffRecord.role||'').toLowerCase();
      const isAdmin = r.includes('admin');
      dbg('Role check => ' + (currentStaffRecord.role || '(none)') + ' => isAdmin=' + isAdmin);
      return isAdmin;
    }catch(err){
      dbg('checkIsAdmin error: ' + (err && err.message));
      showErrorUI('Error checking staff record: ' + (err && err.message));
      return false;
    }
  }

  // open full panel
  openPanelBtn.addEventListener('click', async ()=>{
    adminPanel.style.display = '';
    await loadAllForPanel();
  });

  makeTestNotif.addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if(!user) return showErrorUI('Not signed in');
    try{
      await db.collection('notifications').add({ to: user.email||'', msg: 'Test notice from admin debug at ' + new Date().toISOString(), createdAt: new Date().toISOString() });
      dbg('Test notification created.');
      await loadCountsAndShow();
    }catch(err){ dbg('Create notification failed: ' + (err && err.message)); showErrorUI('Create notification failed: ' + (err && err.message)); }
  });

  // load all for panel (staff list + students + notifications)
  async function loadAllForPanel(){
    dbg('Loading all data for panel...');
    // staff
    try{
      const staffSnap = await db.collection('staff').orderBy('name','asc').get();
      staffList = staffSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      dbg('Loaded staff docs: ' + staffList.length);
      if(staffList.length === 0) staffTbody.innerHTML = '<tr><td colspan="4" class="muted">No staff documents.</td></tr>';
      else {
        staffTbody.innerHTML = staffList.map(s=>`<tr><td>${escapeHtml(s.name||'')}</td><td>${escapeHtml(s.email||'')}</td><td>${escapeHtml(s.role||'')}</td><td>${s.active? 'Yes':'No'}</td></tr>`).join('');
      }
    }catch(err){ dbg('loadAllForPanel staff error: ' + (err && err.message)); staffTbody.innerHTML = `<tr><td colspan="4" class="error">Error loading staff: ${escapeHtml(err.message||err)}</td></tr>`; }

    // students count quick
    try{
      const s = await db.collection('students').get();
      studentsCountEl.textContent = s.size;
      dbg('Loaded students count: ' + s.size);
    }catch(err){ dbg('students load error: ' + (err && err.message)); studentsCountEl.textContent = 'err'; }

    // notifications quick
    try{
      const n = await db.collection('notifications').orderBy('createdAt','desc').limit(10).get();
      notifCountEl.textContent = n.size;
      dbg('Loaded notifications: ' + n.size);
      // render to debug area
      const notes = n.docs.map(dd=> dd.data().msg || JSON.stringify(dd.data())).join('\n---\n');
      dbg('Recent notifications:\\n' + notes);
    }catch(err){ dbg('notifications error: ' + (err && err.message)); notifCountEl.textContent = 'err'; }

  }

  // refresh staff
  btnRefreshStaff.addEventListener('click', loadAllForPanel);

  // search staff (client-side)
  searchStaff.addEventListener('input', ()=>{
    const q = searchStaff.value.trim().toLowerCase();
    if(!q) return renderStaffSample((staffList||[]).slice(0,50).map(s=>({ data: ()=>s })));
    const filtered = (staffList||[]).filter(s => (s.name||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q));
    if(filtered.length) staffTbody.innerHTML = filtered.map(s=>`<tr><td>${escapeHtml(s.name||'')}</td><td>${escapeHtml(s.email||'')}</td><td>${escapeHtml(s.role||'')}</td><td>${s.active? 'Yes':'No'}</td></tr>`).join('');
    else staffTbody.innerHTML = '<tr><td colspan="4" class="muted">No matches</td></tr>';
  });

  // initial debug info
  dbg('Admin debug UI ready. Waiting for user action.');

  </script>
</body>
</html>





