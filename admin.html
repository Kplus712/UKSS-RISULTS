<!doctype html>
<html lang="sw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS ‚Äî Admin (Compact Full)</title>
  <meta name="theme-color" content="#071427" />
  <style>
    /* -------------------------
       Basic look & compact modal
       -------------------------*/
    :root{
      --bg:#071427; --card:#0b1724; --muted:#9fb0c6; --accent:#bfa034; --accent-2:#2ea3ff;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#07111a,#071427);color:#e6eef6;font-size:14px}
    .btn{background:var(--accent);color:#071225;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    input, textarea, select { background: transparent; border:1px solid rgba(255,255,255,0.04); padding:8px; border-radius:8px; color:inherit; }
    textarea{resize:vertical}

    /* Compact admin gate modal (small) */
    .admin-gate-backdrop {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1400;
      background: rgba(0,0,0,0.28);
    }
    .admin-gate-backdrop.active { display:flex; }
    .admin-gate {
      width:460px; max-width:94%; border-radius:12px; padding:14px; background: linear-gradient(180deg,#071427,#061025);
      border:1px solid rgba(255,255,255,0.06); box-shadow: 0 18px 50px rgba(0,0,0,0.6);
    }
    .admin-gate h3{margin:0 0 6px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .error{color:#ff9b9b;margin-top:8px;min-height:18px}

    /* Compact controls inside modal */
    #compactControls { display:none; margin-top:12px; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.03); background:rgba(255,255,255,0.02); }
    .small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
    .small-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* Full admin panel modal (embedded below compact) */
    .admin-panel { margin-top:12px; display:none; border-radius:8px; background:rgba(12,18,32,0.7); padding:10px; border:1px solid rgba(255,255,255,0.04); max-height:58vh; overflow:auto;}
    .panel-tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:var(--muted)}
    .tab.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#071225;border-color:transparent}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-8{grid-column:span 8}
    .col-4{grid-column:span 4}
    .col-12{grid-column:span 12}
    @media(max-width:900px){ .col-8,.col-4,.col-12{grid-column:span 12} }

    .card{background:transparent;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .table { width:100%; border-collapse:collapse; margin-top:8px; }
    thead th{ font-size:12px;color:var(--muted);text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04) }
    tbody td{ padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03) }
    .toggle{appearance:none;width:38px;height:22px;border-radius:999px;background:rgba(255,255,255,0.04);position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .toggle::after{content:"";position:absolute;left:3px;top:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:all .14s}
    .toggle.checked{background:linear-gradient(90deg,var(--accent-2),var(--accent))}
    .toggle.checked::after{transform:translateX(16px);background:#071225}

    .countdown{font-size:20px;font-weight:800;color:var(--accent)}
  </style>
</head>
<body>

  <!-- Example place to add admin trigger: change to match your marks page topbar -->
  <button id="openAdminBtn" class="btn ghost" style="position:fixed;right:18px;bottom:18px;z-index:1000">üîê Admin</button>

  <!-- Compact Admin Gate Backdrop -->
  <div id="adminBackdrop" class="admin-gate-backdrop" aria-hidden="true">
    <div class="admin-gate" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <h3 id="adminTitle">Admin sign-in (compact)</h3>
      <div class="muted">Tumia email & password zako za Firebase. Ikiwa tayari ume-login, unaweza kuingiza tu password (Reauthenticate).</div>

      <div style="margin-top:10px" class="row">
        <input id="gateEmail" type="text" placeholder="Email (acha ikiwa ume-login)" />
      </div>
      <div style="margin-top:8px" class="row">
        <input id="gatePassword" type="password" placeholder="Password" />
      </div>

      <div class="actions">
        <button id="gateCancel" class="btn ghost">Cancel</button>
        <button id="gateSubmit" class="btn">Sign in</button>
      </div>

      <div id="gateError" class="error" role="status"></div>

      <!-- Compact quick controls shown after successful signin & role check -->
      <div id="compactControls">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong id="compactUserLabel"></strong> <div class="small muted" id="compactUserRole"></div></div>
          <div class="muted">Quick actions</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="quickRecalc" class="small-btn">Recalculate Rankings</button>
          <button id="quickDeleteStudent" class="small-btn small-ghost">Delete Student by Index</button>
          <button id="openFullPanel" class="small-btn">Open Admin Panel</button>
          <button id="quickNotif" class="small-btn small-ghost">Create Role Notice</button>
        </div>
      </div>

      <!-- Full admin panel (inside same modal) -->
      <div id="adminPanel" class="admin-panel" aria-hidden="true">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="panel-tabs" role="tablist">
            <div class="tab active" data-tab="tabStaff">Staff</div>
            <div class="tab" data-tab="tabStudents">Students</div>
            <div class="tab" data-tab="tabSettings">Settings</div>
            <div class="tab" data-tab="tabExam">Exam Period</div>
            <div class="tab" data-tab="tabLogs">Logs</div>
          </div>
          <div><button id="closePanelBtn" class="btn ghost">Close panel</button></div>
        </div>

        <div id="tabStaff" class="card" style="margin-top:10px">
          <h4 style="margin:0 0 6px">Staff Management</h4>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="staffSearch" placeholder="Search staff name/email" />
            <button id="staffRefresh" class="btn ghost">Refresh</button>
          </div>
          <div style="margin-top:8px;overflow:auto;max-height:220px">
            <table class="table" id="staffTable">
              <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Main Class</th><th>Active</th><th>Updated</th><th></th></tr></thead>
              <tbody><tr><td colspan="7" class="muted">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="tabStudents" class="card" style="margin-top:10px;display:none">
          <h4 style="margin:0 0 6px">Students</h4>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="studentsSearch" placeholder="Search by name or index" />
            <button id="studentsRefresh" class="btn ghost">Refresh</button>
          </div>
          <div style="margin-top:8px;overflow:auto;max-height:220px">
            <table class="table" id="studentsTable">
              <thead><tr><th>Index</th><th>Name</th><th>Total</th><th>Average</th><th>Rank</th><th>Actions</th></tr></thead>
              <tbody><tr><td colspan="6" class="muted">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="tabSettings" class="card" style="margin-top:10px;display:none">
          <h4 style="margin:0 0 6px">Settings</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div style="flex:1;min-width:180px"><div class="small muted">School Name</div><input id="setSchool" /></div>
            <div style="width:140px"><div class="small muted">Academic Year</div><input id="setYear" /></div>
          </div>
          <div style="margin-top:8px"><div class="small muted">Grading note</div><textarea id="setNote" rows="3"></textarea></div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="saveSettings" class="btn">Save</button><span id="settingsStatus" class="small muted"></span></div>
        </div>

        <div id="tabExam" class="card" style="margin-top:10px;display:none">
          <h4 style="margin:0 0 6px">Exam Period</h4>
          <div style="display:flex;gap:8px;align-items:center">
            <div><div class="small muted">Start</div><input id="examStart" type="date" /></div>
            <div><div class="small muted">End</div><input id="examEnd" type="date" /></div>
            <div style="margin-left:auto;text-align:right"><div class="small muted">Days left</div><div id="daysLeft" class="countdown">‚Äî</div></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
            <button id="saveExam" class="btn">Save Period</button>
            <button id="clearExam" class="btn ghost">Clear</button>
          </div>
        </div>

        <div id="tabLogs" class="card" style="margin-top:10px;display:none">
          <h4 style="margin:0 0 6px">Notifications / Logs</h4>
          <div style="overflow:auto;max-height:220px">
            <table class="table" id="logsTable">
              <thead><tr><th>Time</th><th>To</th><th>Message</th></tr></thead>
              <tbody><tr><td colspan="3" class="muted">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div> <!-- adminPanel -->
    </div>
  </div>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  /*****************************************************************
   * IMPORTANT:
   * Replace firebaseConfig with your project's config below.
   * If Firebase is already initialized elsewhere (e.g., database.js),
   * REMOVE the initializeApp block to avoid double init.
   *****************************************************************/
  const firebaseConfig = {
    apiKey: "PASTE_API_KEY_HERE",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    // ...other keys...
  };

  if(!firebase.apps || !firebase.apps.length){
    try {
      firebase.initializeApp(firebaseConfig);
    } catch(e){
      console.error('Firebase init error', e);
    }
  }

  const auth = firebase.auth();
  const db = firebase.firestore();
  </script>

  <script>
  (function(){
    // UI refs
    const openAdminBtn = document.getElementById('openAdminBtn');
    const backdrop = document.getElementById('adminBackdrop');
    const gateEmail = document.getElementById('gateEmail');
    const gatePassword = document.getElementById('gatePassword');
    const gateError = document.getElementById('gateError');
    const gateSubmit = document.getElementById('gateSubmit');
    const gateCancel = document.getElementById('gateCancel');

    const compactControls = document.getElementById('compactControls');
    const compactUserLabel = document.getElementById('compactUserLabel');
    const compactUserRole = document.getElementById('compactUserRole');

    const quickRecalc = document.getElementById('quickRecalc');
    const quickDeleteStudent = document.getElementById('quickDeleteStudent');
    const openFullPanel = document.getElementById('openFullPanel');
    const quickNotif = document.getElementById('quickNotif');

    const adminPanel = document.getElementById('adminPanel');
    const panelTabs = Array.from(document.querySelectorAll('.tab'));
    const tabSections = {
      tabStaff: document.getElementById('tabStaff'),
      tabStudents: document.getElementById('tabStudents'),
      tabSettings: document.getElementById('tabSettings'),
      tabExam: document.getElementById('tabExam'),
      tabLogs: document.getElementById('tabLogs')
    };
    const closePanelBtn = document.getElementById('closePanelBtn');

    // staff
    const staffTableBody = document.querySelector('#staffTable tbody');
    const staffSearch = document.getElementById('staffSearch');
    const staffRefresh = document.getElementById('staffRefresh');

    // students
    const studentsTableBody = document.querySelector('#studentsTable tbody');
    const studentsSearch = document.getElementById('studentsSearch');
    const studentsRefresh = document.getElementById('studentsRefresh');

    // settings
    const setSchool = document.getElementById('setSchool');
    const setYear = document.getElementById('setYear');
    const setNote = document.getElementById('setNote');
    const saveSettings = document.getElementById('saveSettings');
    const settingsStatus = document.getElementById('settingsStatus');

    // exam
    const examStart = document.getElementById('examStart');
    const examEnd = document.getElementById('examEnd');
    const daysLeft = document.getElementById('daysLeft');
    const saveExam = document.getElementById('saveExam');
    const clearExam = document.getElementById('clearExam');

    // logs
    const logsTableBody = document.querySelector('#logsTable tbody');

    // local models
    let staffList = [];
    let studentsList = [];
    let notificationsList = [];
    let currentStaffRecord = null;

    // helpers
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
    function flash(el,txt){ if(!el) return; el.textContent = txt; setTimeout(()=>el.textContent='',1800); }

    // open compact gate
    openAdminBtn.addEventListener('click', async ()=>{
      gateError.textContent = '';
      compactControls.style.display = 'none';
      adminPanel.style.display = 'none';
      // prefill email if user logged in
      const user = auth.currentUser;
      if(user && user.email) gateEmail.value = user.email;
      backdrop.classList.add('active');
      gatePassword.focus();
    });

    gateCancel.addEventListener('click', ()=> {
      backdrop.classList.remove('active');
      gatePassword.value = ''; gateError.textContent = '';
    });

    // sign-in / reauthenticate flow
    gateSubmit.addEventListener('click', async ()=>{
      gateError.textContent = '';
      gateSubmit.disabled = true;
      const email = (gateEmail.value||'').trim();
      const pw = gatePassword.value || '';
      if(!email || !pw){ gateError.textContent = 'Ingiza email na password.'; gateSubmit.disabled = false; return; }

      try{
        let user;
        // if someone already logged and same email -> reauthenticate
        if(auth.currentUser && auth.currentUser.email === email){
          try{
            const cred = firebase.auth.EmailAuthProvider.credential(email, pw);
            await auth.currentUser.reauthenticateWithCredential(cred);
            user = auth.currentUser;
          }catch(reErr){
            // fall back to signInWithEmailAndPassword
            const res = await auth.signInWithEmailAndPassword(email, pw);
            user = res.user;
          }
        } else {
          const res = await auth.signInWithEmailAndPassword(email, pw);
          user = res.user;
        }

        // check role in staff collection (uid first, then by email)
        const isAdmin = await checkIsAdmin(user);
        if(!isAdmin){
          // signout if we signed in with non-admin
          try{ await auth.signOut(); } catch(e){}
          gateError.textContent = 'Huna ruhusa ya Admin kwa account hii.';
          gateSubmit.disabled = false;
          return;
        }

        // authorized -> show compact controls
        compactUserLabel.textContent = user.displayName || user.email || user.uid;
        compactUserRole.textContent = currentStaffRecord ? ('Role: ' + (currentStaffRecord.role||'')) : '';
        compactControls.style.display = '';
        adminPanel.style.display = 'none';
        gatePassword.value = '';
        gateError.textContent = '';
      } catch(err){
        console.error('gate sign-in error', err);
        if(err && err.message && err.message.includes('API key not valid')) gateError.textContent = 'API key invalid ‚Äî tafadhali weka firebaseConfig sahihi au toa duplicate init.';
        else if(err && err.code === 'auth/wrong-password') gateError.textContent = 'Password sio sahihi.';
        else if(err && err.code === 'auth/user-not-found') gateError.textContent = 'Account haipo.';
        else gateError.textContent = err.message || 'Login failed';
      } finally {
        gateSubmit.disabled = false;
      }
    });

    async function checkIsAdmin(user){
      if(!user) return false;
      try{
        // try doc by uid
        const docRef = db.collection('staff').doc(user.uid);
        const snap = await docRef.get();
        if(snap.exists){
          currentStaffRecord = { id: snap.id, ...snap.data() };
        } else {
          const q = await db.collection('staff').where('email','==', user.email).limit(1).get();
          if(!q.empty) currentStaffRecord = { id: q.docs[0].id, ...q.docs[0].data() };
        }
        if(!currentStaffRecord) return false;
        return (currentStaffRecord.role||'').toLowerCase().includes('admin');
      }catch(err){
        console.error('checkIsAdmin',err);
        throw err;
      }
    }

    // quick actions
    quickRecalc.addEventListener('click', async ()=>{
      // placeholder ‚Äî plug your recalc logic here (or call cloud function)
      alert('Recalculate rankings ‚Äî run your recalc function here.');
    });

    quickDeleteStudent.addEventListener('click', async ()=>{
      const idx = prompt('Weka index ya mwanafunzi kufuta (mfano: 12345):');
      if(!idx) return;
      if(!confirm('Una hakika unataka kufuta record ya mwanafunzi mwenye index: ' + idx + ' ?')) return;
      try{
        // search student by index and delete first match
        const q = await db.collection('students').where('index','==', idx).limit(1).get();
        if(q.empty){ alert('Student not found'); return; }
        const id = q.docs[0].id;
        await db.collection('students').doc(id).delete();
        alert('Student deleted');
      }catch(err){ console.error(err); alert('Delete failed: '+(err.message||err)); }
    });

    quickNotif.addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if(!user){ alert('Not signed in'); return; }
      try{
        await db.collection('notifications').add({ to: user.email||'', msg: 'Quick admin notification', createdAt: new Date().toISOString() });
        alert('Notification created');
      }catch(err){ console.error(err); alert('Failed to create notification: '+(err.message||err)); }
    });

    openFullPanel.addEventListener('click', async ()=>{
      // load full admin panel data and show
      await loadAllForPanel();
      adminPanel.style.display = '';
    });

    closePanelBtn.addEventListener('click', ()=> {
      adminPanel.style.display = 'none';
    });

    // panel tab switching
    panelTabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        panelTabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const id = t.dataset.tab;
        Object.keys(tabSections).forEach(k=> tabSections[k].style.display = 'none');
        const section = tabSections[id];
        if(section) section.style.display = '';
      });
    });

    // ----------------- FULL PANEL: STAFF -----------------
    async function loadStaff(){
      staffTableBody.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
      try{
        const snap = await db.collection('staff').orderBy('name','asc').get();
        staffList = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderStaff(staffList);
      }catch(err){ console.error(err); staffTableBody.innerHTML = '<tr><td colspan="7" class="muted">Failed to load</td></tr>'; }
    }

    function renderStaff(list){
      if(!list || list.length===0){ staffTableBody.innerHTML = '<tr><td colspan="7" class="muted">Hakuna staff</td></tr>'; return; }
      const rows = list.map(s=> {
        const checked = s.active ? 'checked' : '';
        return `<tr data-id="${s.id}">
          <td><strong>${escapeHtml(s.name||'')}</strong></td>
          <td>${escapeHtml(s.email||'')}</td>
          <td><select class="roleSel"><option ${s.role==='Admin'?'selected':''}>Admin</option><option ${s.role==='Headmaster'?'selected':''}>Headmaster</option><option ${s.role==='Academic'?'selected':''}>Academic</option><option ${s.role==='Class Teacher'?'selected':''}>Class Teacher</option></select></td>
          <td><input class="mainClass" value="${escapeHtml(s.mainClass||'')}" /></td>
          <td><button class="toggle ${checked}"></button></td>
          <td>${escapeHtml(s.updated||'')}</td>
          <td style="white-space:nowrap"><button class="btn ghost saveRow" data-id="${s.id}" style="padding:6px 8px">Save</button> <button class="btn ghost deleteRow" data-id="${s.id}" style="padding:6px 8px">Delete</button></td>
        </tr>`; }).join('');
      staffTableBody.innerHTML = rows;
    }

    staffSearch.addEventListener('input', e=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q) return renderStaff(staffList);
      renderStaff(staffList.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q)));
    });

    staffRefresh.addEventListener('click', ()=> loadStaff());

    staffTableBody.addEventListener('click', async (ev)=>{
      const t = ev.target;
      const row = t.closest('tr[data-id]');
      if(!row) return;
      const id = row.getAttribute('data-id');

      if(t.classList.contains('toggle')){
        t.classList.toggle('checked');
        return;
      }
      if(t.classList.contains('deleteRow')){
        if(!confirm('Futa staff kabisa?')) return;
        try{ await db.collection('staff').doc(id).delete(); alert('Deleted'); await loadStaff(); } catch(err){ console.error(err); alert('Delete failed: '+err.message) }
        return;
      }
      if(t.classList.contains('saveRow')){
        try{
          const role = row.querySelector('.roleSel').value;
          const mainClass = row.querySelector('.mainClass').value;
          const active = row.querySelector('.toggle').classList.contains('checked');
          const docRef = db.collection('staff').doc(id);
          // fetch before to detect role change
          const beforeSnap = await docRef.get();
          const before = beforeSnap.exists ? beforeSnap.data() : null;
          await docRef.set({ role, mainClass, active, updated: new Date().toISOString() }, { merge:true });
          // if role changed, create notification
          if(before && before.role !== role){
            const msg = `${before.name || before.email}: Umepewa role ya "${role}".`;
            await db.collection('notifications').add({ to: before.email||'', msg, createdAt: new Date().toISOString() });
          }
          alert('Saved');
          await loadStaff();
        }catch(err){ console.error(err); alert('Save failed: '+err.message) }
      }
    });

    // ----------------- FULL PANEL: STUDENTS -----------------
    async function loadStudents(){
      studentsTableBody.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
      try{
        const snap = await db.collection('students').orderBy('index','asc').get();
        studentsList = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderStudents(studentsList);
      }catch(err){ console.error(err); studentsTableBody.innerHTML = '<tr><td colspan="6" class="muted">Failed</td></tr>'; }
    }

    function renderStudents(list){
      if(!list || list.length===0){ studentsTableBody.innerHTML = '<tr><td colspan="6" class="muted">Hakuna students</td></tr>'; return; }
      const rows = list.map(s=>`<tr data-id="${s.id}"><td>${escapeHtml(s.index||'')}</td><td><strong>${escapeHtml(s.name||'')}</strong></td><td>${typeof s.total==='number'? s.total.toFixed(2):'-'}</td><td>${typeof s.average==='number'? s.average.toFixed(2):'-'}</td><td>${s.rank||'-'}</td><td><button class="btn ghost viewStud" data-id="${s.id}" style="padding:6px 8px">View</button> <button class="btn ghost deleteStud" data-id="${s.id}" style="padding:6px 8px">Delete</button></td></tr>`).join('');
      studentsTableBody.innerHTML = rows;
    }

    studentsSearch.addEventListener('input', e=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q) return renderStudents(studentsList);
      renderStudents(studentsList.filter(s=> (s.name||'').toLowerCase().includes(q) || String(s.index||'').toLowerCase().includes(q)));
    });

    studentsRefresh.addEventListener('click', ()=> loadStudents());

    studentsTableBody.addEventListener('click', async (ev)=>{
      const t = ev.target;
      const row = t.closest('tr[data-id]');
      if(!row) return;
      const id = row.getAttribute('data-id');
      if(t.classList.contains('viewStud')){
        const s = studentsList.find(x=>x.id===id);
        if(!s) return alert('Student not found');
        alert('Student:\\n\\n'+JSON.stringify(s,null,2));
      }
      if(t.classList.contains('deleteStud')){
        if(!confirm('Una hakika unataka kufuta record ya mwanafunzi?')) return;
        try{ await db.collection('students').doc(id).delete(); alert('Deleted'); await loadStudents(); } catch(err){ console.error(err); alert('Delete failed: '+err.message) }
      }
    });

    // ----------------- SETTINGS -----------------
    async function loadSettings(){
      try{
        const doc = await db.collection('settings').doc('global').get();
        if(doc.exists){
          const d = doc.data();
          setSchool.value = d.schoolName || '';
          setYear.value = d.academicYear || '';
          setNote.value = d.gradingNote || '';
          if(d.examPeriod){
            examStart.value = d.examPeriod.start || '';
            examEnd.value = d.examPeriod.end || '';
          }
        }
      }catch(err){ console.error(err); }
    }

    saveSettings.addEventListener('click', async ()=>{
      const payload = { schoolName: setSchool.value.trim(), academicYear: setYear.value.trim(), gradingNote: setNote.value.trim(), updated:new Date().toISOString() };
      try{ await db.collection('settings').doc('global').set(payload,{merge:true}); flash(settingsStatus,'Saved'); } catch(err){ console.error(err); settingsStatus.textContent='Save failed'; }
    });

    // ----------------- EXAM PERIOD -----------------
    async function saveExamPeriod(){
      const s = examStart.value; const e = examEnd.value;
      if(!s || !e){ alert('Weka start na end'); return; }
      try{
        await db.collection('settings').doc('global').set({ examPeriod: { start: s, end: e }, updated: new Date().toISOString() }, { merge:true });
        updateDaysLeft();
        flash(settingsStatus,'Saved');
      }catch(err){ console.error(err); alert('Save failed: '+err.message); }
    }

    async function clearExamPeriod(){
      if(!confirm('Futa exam period?')) return;
      try{
        await db.collection('settings').doc('global').set({ examPeriod: firebase.firestore.FieldValue.delete(), updated: new Date().toISOString() }, { merge:true });
        examStart.value = ''; examEnd.value = ''; updateDaysLeft();
        flash(settingsStatus,'Cleared');
      }catch(err){ console.error(err); alert('Clear failed: '+err.message); }
    }

    function updateDaysLeft(){
      const s = examStart.value; const e = examEnd.value;
      if(!s || !e){ daysLeft.textContent = '‚Äî'; return; }
      const end = new Date(e + 'T23:59:59'); const now = new Date();
      const diff = end - now;
      if(diff < 0) { daysLeft.textContent = 'Ended'; return; }
      const days = Math.ceil(diff / (1000*60*60*24));
      daysLeft.textContent = days + ' day' + (days>1?'s':'') + ' left';
    }

    saveExam.addEventListener('click', saveExamPeriod);
    clearExam.addEventListener('click', clearExamPeriod);
    examStart.addEventListener('change', updateDaysLeft);
    examEnd.addEventListener('change', updateDaysLeft);

    // ----------------- LOGS -----------------
    async function loadNotifications(){
      logsTableBody.innerHTML = '<tr><td colspan="3" class="muted">Loading...</td></tr>';
      try{
        const snap = await db.collection('notifications').orderBy('createdAt','desc').limit(50).get();
        notificationsList = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderNotifications(notificationsList);
      }catch(err){ console.error(err); logsTableBody.innerHTML = '<tr><td colspan="3" class="muted">Failed</td></tr>'; }
    }

    function renderNotifications(list){
      if(!list.length){ logsTableBody.innerHTML = '<tr><td colspan="3" class="muted">Hakuna notifications</td></tr>'; return; }
      const rows = list.map(n=>`<tr><td>${escapeHtml(n.createdAt || '')}</td><td>${escapeHtml(n.to||'')}</td><td>${escapeHtml(n.msg||'')}</td></tr>`).join('');
      logsTableBody.innerHTML = rows;
    }

    // ----------------- Load all for panel -----------------
    async function loadAllForPanel(){
      await Promise.all([loadStaff(), loadStudents(), loadSettings(), loadNotifications()]);
      updateDaysLeft();
    }

    // Expose a function to open gate from other code
    window.openAdminCompact = ()=> openAdminBtn.click();

    // close modal by clicking outside
    backdrop.addEventListener('click', (e)=> { if(e.target === backdrop) backdrop.classList.remove('active'); });

    // auth state listener: update compact user info
    auth.onAuthStateChanged((u)=>{
      if(u){
        compactUserLabel.textContent = u.email || u.uid;
      } else {
        compactUserLabel.textContent = '';
        compactUserRole.textContent = '';
        compactControls.style.display = 'none';
        adminPanel.style.display = 'none';
      }
    });

    // expose some functions for integration
    window.admin_recalcPlaceholder = ()=> alert('Run your recalc logic here');

  })();
  </script>
</body>
</html>


