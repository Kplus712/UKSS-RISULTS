<!doctype html>
<html lang="sw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS ‚Äî Admin (Improved)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#071226;
      --muted:#9fb0c6;
      --accent:#bfa034;
      --accent-2:#2ea3ff;
      --glass: rgba(255,255,255,0.03);
      --card-radius:12px;
      --gap:14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background: linear-gradient(180deg,#07111a 0%, #071427 100%);
      color:#e6eef6;
      font-size:14px;
      line-height:1.4;
    }

    /* layout */
    .app{display:grid;grid-template-columns:260px 1fr;gap:var(--gap);min-height:100vh}
    .sidebar{
      padding:20px;
      border-right:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .brand-badge{width:48px;height:48px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#071225}
    .brand-title{font-weight:700;font-size:16px}
    .brand-sub{font-size:12px;color:var(--muted)}

    .nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .nav a{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:var(--muted);text-decoration:none;
      transition:all .15s;
    }
    .nav a:hover{background:var(--glass);color:#fff}
    .nav a.active{background:linear-gradient(90deg, rgba(191,160,52,0.12), transparent);color:#fff;border-left:3px solid var(--accent);padding-left:8px}

    /* main */
    .main{padding:18px 22px;overflow:auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
    .topbar h2{margin:0;font-size:18px}
    .topbar .small{color:var(--muted);font-size:13px;margin-top:4px}

    .btn{
      background:var(--accent);color:#071225;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;
    }
    .btn.btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);font-weight:600}
    .btn.btn-primary{background:var(--accent-2);color:#071225}
    .small{font-size:13px;color:var(--muted)}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      align-items:start;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.03);
      padding:14px;border-radius:var(--card-radius);
      box-shadow: 0 4px 10px rgba(2,6,23,0.3);
    }

    /* layout columns */
    .col-4{grid-column: span 4}
    .col-8{grid-column: span 8}
    .col-12{grid-column: span 12}

    /* fields */
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1;min-width:180px;display:flex;flex-direction:column;gap:6px}
    .label{font-size:13px;color:var(--muted)}
    .input, .textarea, select{
      background:transparent;border:1px solid rgba(255,255,255,0.04);padding:9px 10px;border-radius:10px;color:inherit;
    }
    .textarea{min-height:72px;resize:vertical}

    /* tables */
    .matrix-wrap{overflow:auto}
    table.table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{font-size:12px;text-align:left;padding:10px 8px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.03)}
    tbody td{padding:10px 8px;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .badge{padding:6px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,0.02);color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px}

    .muted{color:var(--muted)}
    .danger{color:#ff9b9b}

    /* responsive */
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr; }
      .sidebar{display:flex;justify-content:space-between;align-items:center}
      .nav{flex-direction:row;overflow:auto;margin-top:0}
      .col-4, .col-8{grid-column: span 12}
    }

    /* small helpers */
    .row-actions{display:flex;gap:8px}
    .toggle{appearance:none;width:42px;height:26px;border-radius:999px;background:rgba(255,255,255,0.06);position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .toggle::after{content:"";position:absolute;left:4px;top:4px;width:18px;height:18px;border-radius:50%;background:#fff;transition:all .15s}
    .toggle.checked{background:linear-gradient(90deg,var(--accent-2),var(--accent));}
    .toggle.checked::after{transform:translateX(16px);background:#071225}

    .tiny{font-size:12px;color:var(--muted)}
    .status{font-size:13px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .notice{padding:8px;border-radius:8px;background:rgba(46,163,255,0.06);color:var(--muted);border:1px solid rgba(46,163,255,0.06)}
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar card" aria-label="sidebar">
      <div class="brand">
        <div class="brand-badge">UK</div>
        <div>
          <div class="brand-title">UKSS</div>
          <div class="brand-sub">Results Management</div>
        </div>
      </div>

      <nav class="nav" id="mainNav">
        <a href="#" data-view="marks">üè† Marks</a>
        <a href="#" data-view="results">üìÑ Results</a>
        <a href="#" data-view="ranking">üèÜ Ranking</a>
        <a href="#" data-view="behaviour">üß≠ Behaviour</a>
        <a href="#" data-view="sms">üì® SMS</a>
        <a href="#" data-view="sms_logs">üßæ SMS Logs</a>
        <a href="#" data-view="admin" class="active">üîê Admin</a>
      </nav>
      <div style="margin-top:14px" class="small muted">Signed in as <strong id="meNameSide">Admin</strong></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <header class="topbar">
        <div>
          <h2>üîê Admin Control Center</h2>
          <div class="small muted">Full control kwa system owner: staff roles, system settings, logs na approvals za access.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="logoutBtn" class="btn btn-ghost">Logout</button>
          <button id="collapseSidebar" class="btn btn-ghost tiny">Toggle Nav</button>
        </div>
      </header>

      <!-- layout grid -->
      <div class="grid">
        <!-- Account card -->
        <div class="card col-4">
          <h3>Your Account</h3>
          <p class="small muted">Taarifa zako na role uliyopewa.</p>
          <div class="row" style="margin-top:10px">
            <div class="field"><label class="label">Name</label><input id="meName" class="input" type="text" disabled /></div>
            <div class="field"><label class="label">Email</label><input id="meEmail" class="input" type="text" disabled /></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="field"><label class="label">Role</label><input id="meRole" class="input" type="text" disabled /></div>
            <div class="field"><label class="label">Main Class</label><input id="meClass" class="input" type="text" disabled /></div>
          </div>
          <div id="roleWarning" class="small danger" style="margin-top:10px;display:none"></div>
        </div>

        <!-- Staff management -->
        <div class="card col-8">
          <h3>1. Staff Management</h3>
          <p class="small muted">Badili roles, class na status ya staff. ‚ÄúActive‚Äù ikizimwa, user hawezi login.</p>

          <div class="controls" style="margin-top:10px">
            <input id="staffSearch" class="input" placeholder="Search name or email..." style="width:100%" />
            <button id="refreshStaff" class="btn btn-ghost tiny">Refresh</button>
          </div>

          <div class="matrix-wrap" style="margin-top:10px">
            <table class="table" id="staffTable" aria-describedby="staffTableDesc">
              <thead>
                <tr>
                  <th>Name</th><th>Email</th><th>Role</th><th>Main Class</th><th>Active</th><th>Updated</th><th></th>
                </tr>
              </thead>
              <tbody><tr><td colspan="7" class="muted tiny">Loading staff...</td></tr></tbody>
            </table>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <button id="saveStaffBtn" class="btn btn-primary tiny">Save changes</button>
            <div id="staffStatus" class="tiny muted"></div>
          </div>
        </div>

        <!-- Pending approvals -->
        <div class="card col-12">
          <h3>2. Access Control & Approvals</h3>
          <p class="small muted">Staff wapya au wasio na role/active wataonekana hapa. Wape role sahihi na uwasha ‚ÄúActive‚Äù.</p>

          <div class="matrix-wrap" style="margin-top:10px">
            <table class="table" id="pendingTable">
              <thead>
                <tr><th>Name</th><th>Email</th><th>Current Role</th><th>New Role</th><th>Set Active</th><th>Apply</th></tr>
              </thead>
              <tbody><tr><td colspan="6" class="muted tiny">Hakuna pending staff.</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- System settings -->
        <div class="card col-8">
          <h3>3. System Settings</h3>
          <p class="small muted">Taarifa za shule na baadhi ya settings. Zitahifadhiwa localStorage kwa demo ‚Äî badilisha ili kufunga DB/server.</p>

          <div class="row" style="margin-top:10px">
            <div class="field"><label class="label">School Name</label><input id="setSchoolName" class="input" placeholder="eg. Mambosasa Secondary School" /></div>
            <div class="field"><label class="label">School Motto</label><input id="setSchoolMotto" class="input" placeholder="eg. Discipline and Excellence" /></div>
            <div class="field"><label class="label">School Address</label><input id="setSchoolAddress" class="input" placeholder="eg. P.O. Box 123, Dar es Salaam" /></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field"><label class="label">School Phone</label><input id="setSchoolPhone" class="input" placeholder="eg. 0789 000 000" /></div>
            <div class="field"><label class="label">Current SMS Provider</label><input id="setSmsProvider" class="input" value="Beem Africa" /></div>
            <div class="field"><label class="label">Academic Year</label><input id="setAcademicYear" class="input" placeholder="eg. 2025" /></div>
          </div>

          <div style="margin-top:10px">
            <label class="label">Grading Scale (summary)</label>
            <textarea id="setGradingNote" class="textarea" placeholder="eg. A: 75‚Äì100, B: 65‚Äì74, C: 45‚Äì64..."></textarea>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="saveSettingsBtn" class="btn">Save Settings</button>
            <div id="settingsStatus" class="tiny muted"></div>
          </div>
        </div>

        <!-- Logs -->
        <div class="card col-4">
          <h3>4. Logs & Overview</h3>
          <p class="small muted">Muhtasari wa rekodi muhimu.</p>
          <div style="margin-top:10px" class="row">
            <div class="field"><label class="label">Total SMS Logs</label><input id="logSmsCount" class="input" type="text" disabled value="0" /></div>
            <div class="field"><label class="label">Total Report Cards</label><input id="logReportsCount" class="input" type="text" disabled value="0" /></div>
            <div class="field"><label class="label">Total Behaviour Records</label><input id="logBehaviourCount" class="input" type="text" disabled value="0" /></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <a href="sms_logs.html" class="btn btn-ghost tiny">Open SMS Logs</a>
            <a href="results.html" class="btn btn-ghost tiny">Open Results</a>
          </div>
        </div>

      </div> <!-- grid -->
    </main>
  </div>

  <!-- lightweight behaviour (demo uses localStorage). Replace handlers with your API calls (Firebase) -->
  <script>
    // Demo data
    const demoStaff = [
      { id: 's1', name:'Asha M. K', email:'asha@school.tz', role:'Admin', mainClass:'', active:true, updated:'2025-11-20' },
      { id: 's2', name:'James L. P', email:'james@school.tz', role:'Class Teacher', mainClass:'Form 1A', active:true, updated:'2025-11-18' },
      { id: 's3', name:'Fatima R', email:'fatima@school.tz', role:'Academic', mainClass:'', active:false, updated:'2025-10-08' },
    ];
    const demoPending = [
      { id:'p1', name:'New Staff', email:'new@school.tz', currentRole:'', requestedRole:'Class Teacher' }
    ];

    // Utils
    const $ = sel => document.querySelector(sel);
    const renderStaffTable = (list) => {
      const tbody = document.querySelector('#staffTable tbody');
      if(!list || list.length===0) { tbody.innerHTML = '<tr><td colspan="7" class="muted tiny">Hakuna staff.</td></tr>'; return; }
      tbody.innerHTML = '';
      list.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${escapeHtml(s.name)}</strong></td>
          <td>${escapeHtml(s.email)}</td>
          <td>
            <select data-id="${s.id}" class="roleSelect">
              <option ${s.role==='Admin'?'selected':''}>Admin</option>
              <option ${s.role==='Headmaster'?'selected':''}>Headmaster</option>
              <option ${s.role==='Academic'?'selected':''}>Academic</option>
              <option ${s.role==='Class Teacher'?'selected':''}>Class Teacher</option>
            </select>
          </td>
          <td><input data-id="${s.id}" class="input mainClassInput" value="${escapeHtml(s.mainClass||'')}" /></td>
          <td><button class="toggle ${s.active?'checked':''}" data-id="${s.id}" title="Toggle active"></button></td>
          <td>${s.updated||''}</td>
          <td class="row-actions">
            <button class="btn btn-ghost tiny" data-id="${s.id}" data-action="impersonate">Impersonate</button>
            <button class="btn tiny" data-id="${s.id}" data-action="save">Save</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    };

    const renderPending = (list) => {
      const tbody = document.querySelector('#pendingTable tbody');
      if(!list || list.length===0) { tbody.innerHTML = '<tr><td colspan="6" class="muted tiny">Hakuna pending staff.</td></tr>'; return; }
      tbody.innerHTML = '';
      list.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.email)}</td>
          <td>${escapeHtml(p.currentRole||'-')}</td>
          <td>
            <select data-id="${p.id}" class="pendingRole">
              <option ${p.requestedRole==='Admin'?'selected':''}>Admin</option>
              <option ${p.requestedRole==='Headmaster'?'selected':''}>Headmaster</option>
              <option ${p.requestedRole==='Academic'?'selected':''}>Academic</option>
              <option ${p.requestedRole==='Class Teacher'?'selected':''}>Class Teacher</option>
            </select>
          </td>
          <td><button class="toggle ${p.active?'checked':''}" data-id="${p.id}" title="Set active (pending)"></button></td>
          <td><button class="btn btn-primary tiny" data-id="${p.id}" data-action="apply">Apply</button></td>
        `;
        tbody.appendChild(tr);
      });
    };

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    // init
    let staff = JSON.parse(localStorage.getItem('ukss_staff')) || demoStaff.slice();
    let pending = JSON.parse(localStorage.getItem('ukss_pending')) || demoPending.slice();
    const settings = JSON.parse(localStorage.getItem('ukss_settings')) || {
      schoolName:'Mambosasa Secondary School',
      schoolMotto:'Discipline and Excellence',
      schoolAddress:'P.O. Box 123, Dar es Salaam',
      schoolPhone:'0789 000 000',
      smsProvider:'Beem Africa',
      academicYear:'2025',
      gradingNote:'A: 75‚Äì100, B: 65‚Äì74, C: 45‚Äì64, D: 25‚Äì44, E: 0‚Äì24'
    };

    // populate UI
    document.getElementById('meName').value = settings.schoolName ? 'System Owner' : 'Admin User';
    document.getElementById('meEmail').value = 'owner@school.tz';
    document.getElementById('meRole').value = 'Admin';
    document.getElementById('meClass').value = '';

    // settings fields
    document.getElementById('setSchoolName').value = settings.schoolName || '';
    document.getElementById('setSchoolMotto').value = settings.schoolMotto || '';
    document.getElementById('setSchoolAddress').value = settings.schoolAddress || '';
    document.getElementById('setSchoolPhone').value = settings.schoolPhone || '';
    document.getElementById('setSmsProvider').value = settings.smsProvider || '';
    document.getElementById('setAcademicYear').value = settings.academicYear || '';
    document.getElementById('setGradingNote').value = settings.gradingNote || '';

    // render initial
    renderStaffTable(staff);
    renderPending(pending);
    document.getElementById('logSmsCount').value = localStorage.getItem('ukss_logs_sms') || '0';
    document.getElementById('logReportsCount').value = localStorage.getItem('ukss_reports_count') || '0';
    document.getElementById('logBehaviourCount').value = localStorage.getItem('ukss_behaviour_count') || '0';

    // events
    document.getElementById('staffSearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      const filtered = staff.filter(s => s.name.toLowerCase().includes(q) || s.email.toLowerCase().includes(q));
      renderStaffTable(filtered);
    });

    document.getElementById('refreshStaff').addEventListener('click', ()=>{
      staff = JSON.parse(localStorage.getItem('ukss_staff')) || demoStaff.slice();
      renderStaffTable(staff);
      document.getElementById('staffStatus').innerText = 'Refreshed';
      setTimeout(()=> document.getElementById('staffStatus').innerText = '', 1800);
    });

    // generic toggle & actions using event delegation
    document.addEventListener('click', (ev)=>{
      const t = ev.target;
      if(t.matches('.toggle')){
        t.classList.toggle('checked');
        // reflect into staff/pending model
        const id = t.getAttribute('data-id');
        let found = staff.find(s=>s.id===id);
        if(found){ found.active = t.classList.contains('checked'); found.updated = new Date().toISOString().slice(0,10); localStorage.setItem('ukss_staff', JSON.stringify(staff)); }
        found = pending.find(p=>p.id===id);
        if(found){ found.active = t.classList.contains('checked'); localStorage.setItem('ukss_pending', JSON.stringify(pending)); }
      } else if(t.matches('button[data-action="save"]')){
        const id = t.getAttribute('data-id');
        const row = t.closest('tr');
        const role = row.querySelector('.roleSelect').value;
        const mainClass = row.querySelector('.mainClassInput').value;
        const st = staff.find(s=>s.id===id);
        if(st){ st.role = role; st.mainClass = mainClass; st.updated = new Date().toISOString().slice(0,10); localStorage.setItem('ukss_staff', JSON.stringify(staff)); renderStaffTable(staff); flashStatus('#staffStatus','Saved'); }
      } else if(t.matches('button[data-action="impersonate"]')){
        const id = t.getAttribute('data-id');
        const s = staff.find(x=>x.id===id);
        if(s) alert('Impersonate demo: will open dashboard as ' + s.name);
      } else if(t.matches('button[data-action="apply"]')){
        const id = t.getAttribute('data-id');
        const row = t.closest('tr');
        const newRole = row.querySelector('.pendingRole').value;
        // move to staff
        const pIdx = pending.findIndex(x=>x.id===id);
        if(pIdx>-1){
          const p = pending.splice(pIdx,1)[0];
          const newStaff = { id: 's'+Date.now(), name:p.name, email:p.email, role:newRole, mainClass:'', active:true, updated:new Date().toISOString().slice(0,10) };
          staff.push(newStaff);
          localStorage.setItem('ukss_staff', JSON.stringify(staff));
          localStorage.setItem('ukss_pending', JSON.stringify(pending));
          renderStaffTable(staff);
          renderPending(pending);
          flashStatus('#staffStatus','Applied');
        }
      }
    });

    // Save all staff changes (collect UI values)
    document.getElementById('saveStaffBtn').addEventListener('click', ()=>{
      // gather from table
      document.querySelectorAll('#staffTable tbody tr').forEach(tr=>{
        const roleSel = tr.querySelector('.roleSelect');
        const mainIn = tr.querySelector('.mainClassInput');
        const toggle = tr.querySelector('.toggle');
        if(!roleSel) return;
        const id = roleSel.getAttribute('data-id');
        const s = staff.find(x=>x.id===id);
        if(s){
          s.role = roleSel.value;
          s.mainClass = mainIn.value;
          s.active = toggle.classList.contains('checked');
          s.updated = new Date().toISOString().slice(0,10);
        }
      });
      localStorage.setItem('ukss_staff', JSON.stringify(staff));
      flashStatus('#staffStatus','All changes saved');
    });

    // Settings save
    document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{
      const S = {
        schoolName: document.getElementById('setSchoolName').value.trim(),
        schoolMotto: document.getElementById('setSchoolMotto').value.trim(),
        schoolAddress: document.getElementById('setSchoolAddress').value.trim(),
        schoolPhone: document.getElementById('setSchoolPhone').value.trim(),
        smsProvider: document.getElementById('setSmsProvider').value.trim(),
        academicYear: document.getElementById('setAcademicYear').value.trim(),
        gradingNote: document.getElementById('setGradingNote').value.trim()
      };
      localStorage.setItem('ukss_settings', JSON.stringify(S));
      document.getElementById('settingsStatus').innerText = 'Saved';
      setTimeout(()=> document.getElementById('settingsStatus').innerText = '', 1800);
    });

    // sidebar toggle
    document.getElementById('collapseSidebar').addEventListener('click', ()=>{
      document.querySelector('.sidebar').classList.toggle('collapsed');
      const nav = document.getElementById('mainNav');
      if(nav.style.display === 'none'){ nav.style.display = ''; } else { nav.style.display = 'flex'; }
    });

    // helper
    function flashStatus(sel, text){
      const el = document.querySelector(sel);
      if(!el) return;
      el.innerText = text;
      setTimeout(()=> el.innerText = '', 2000);
    }

    // persist demo arrays if not present
    if(!localStorage.getItem('ukss_staff')) localStorage.setItem('ukss_staff', JSON.stringify(staff));
    if(!localStorage.getItem('ukss_pending')) localStorage.setItem('ukss_pending', JSON.stringify(pending));
  </script>
</body>
</html>
