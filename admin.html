<!doctype html>
<html lang="sw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS ‚Äî Admin (Firebase)</title>
  <style>
    /* Minimal styling (same look as earlier improved UI) */
    :root{
      --bg:#071427; --accent:#bfa034; --muted:#9fb0c6;
      --card-radius:12px;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color-scheme: dark;
    }
    body{margin:0;background:linear-gradient(180deg,#07111a,#071427);color:#e6eef6;font-size:14px}
    .app{display:grid;grid-template-columns:260px 1fr;gap:14px;min-height:100vh}
    .sidebar{padding:18px;border-right:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand-badge{width:44px;height:44px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#071225;font-weight:700}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:16px}
    .nav a{color:var(--muted);text-decoration:none;padding:8px;border-radius:8px}
    .main{padding:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn{background:var(--accent);color:#071225;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:8px}
    td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .toggle{appearance:none;width:42px;height:26px;border-radius:999px;background:rgba(255,255,255,0.04);position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .toggle::after{content:"";position:absolute;left:4px;top:4px;width:18px;height:18px;border-radius:50%;background:#fff;transition:all .15s}
    .toggle.checked{background:linear-gradient(90deg,#2ea3ff,#bfa034)}
    .toggle.checked::after{transform:translateX(16px);background:#071225}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    /* simple responsive */
    @media (max-width:980px){ .app{grid-template-columns:1fr} .sidebar{display:flex;justify-content:space-between;align-items:center} .nav{flex-direction:row;overflow:auto} }
  </style>
</head>
<body>
  <!-- Firebase SDKs (v8 as requested) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <div class="app">
    <aside class="sidebar card">
      <div class="brand">
        <div class="brand-badge">UK</div>
        <div>
          <div style="font-weight:700">UKSS</div>
          <div class="small">Results Management</div>
        </div>
      </div>

      <nav class="nav">
        <a href="#" data-view="marks">üè† Marks</a>
        <a href="#" data-view="results">üìÑ Results</a>
        <a href="#" data-view="ranking">üèÜ Ranking</a>
        <a href="#" data-view="admin" class="active">üîê Admin</a>
      </nav>

      <div style="margin-top:16px" class="small">Signed in as <strong id="sideName">‚Äî</strong></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h2 style="margin:0">üîê Admin Control Center</h2>
          <div class="small">Ingia kwa Firebase credentials zako. Mfumo utacheki role yako kwenye Firestore.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="authSection">
            <button id="btnShowLogin" class="btn">Login</button>
          </div>
          <button id="btnLogout" class="btn hidden">Logout</button>
        </div>
      </div>

      <!-- LOGIN MODAL (simple inline) -->
      <div id="loginBox" class="card hidden" style="max-width:480px;margin-bottom:12px">
        <h3>Admin Login (Firebase)</h3>
        <div class="small">Tumia email & password ulizoweka kwenye Firebase Auth.</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-direction:column">
          <input id="loginEmail" class="input" placeholder="Email" />
          <input id="loginPassword" class="input" placeholder="Password" type="password" />
          <div style="display:flex;gap:8px;align-items:center">
            <button id="loginBtn" class="btn">Sign in</button>
            <button id="cancelLogin" class="btn" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)">Cancel</button>
          </div>
          <div id="loginError" class="small" style="color:#ff9b9b"></div>
        </div>
      </div>

      <!-- NOT AUTHORIZED NOTICE -->
      <div id="notAuth" class="card hidden">
        <h3>Hauna ruhusa</h3>
        <div class="small">Unaonekana kuwa hauko admin. Tafadhali ingia na account yenye role ya <strong>Admin</strong> au muombe Headmaster/Owner akutole role.</div>
        <div style="margin-top:8px"><button id="btnSignOut2" class="btn">Sign out</button></div>
      </div>

      <!-- ADMIN UI -->
      <div id="adminUI" class="hidden">

        <div class="card" style="margin-bottom:12px">
          <h3>Your Account</h3>
          <div class="small">Taarifa ya msimamizi iliyopatikana kutoka Firestore (au kutoka record yako ya staff).</div>
          <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
            <input id="meName" class="input" placeholder="Name" disabled />
            <input id="meEmail" class="input" placeholder="Email" disabled />
            <input id="meRole" class="input" placeholder="Role" disabled />
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <h3>1. Staff Management</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="staffSearch" class="input" placeholder="Search staff by name or email..." />
            <button id="refreshBtn" class="btn" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)">Refresh</button>
          </div>

          <div id="staffTableWrap" style="margin-top:10px;overflow:auto">
            <table id="staffTable">
              <thead>
                <tr><th>Name</th><th>Email</th><th>Role</th><th>Main Class</th><th>Active</th><th>Updated</th><th>Actions</th></tr>
              </thead>
              <tbody><tr><td colspan="7" class="small">Loading staff...</td></tr></tbody>
            </table>
          </div>

          <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
            <button id="saveAllBtn" class="btn">Save all changes</button>
            <div id="staffStatus" class="small" style="align-self:center;color:var(--muted)"></div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <h3>2. Pending Approvals</h3>
          <div id="pendingWrap" style="margin-top:10px;overflow:auto">
            <table id="pendingTable"><thead><tr><th>Name</th><th>Email</th><th>Requested Role</th><th>Active</th><th>Apply</th></tr></thead><tbody><tr><td colspan="5" class="small">Loading...</td></tr></tbody></table>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <h3>3. System Settings</h3>
          <div class="small">Settings zinahifadhiwa katika `settings/global` doc. Badilisha hapa kisha Save.</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <input id="setSchoolName" class="input" placeholder="School name" style="flex:1" />
            <input id="setAcademicYear" class="input" placeholder="Academic year" style="width:140px" />
          </div>
          <div style="margin-top:8px">
            <textarea id="setGradingNote" class="input" rows="3" placeholder="Grading note" style="width:100%"></textarea>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
            <button id="saveSettings" class="btn">Save Settings</button>
            <div id="settingsStatus" class="small" style="color:var(--muted)"></div>
          </div>
        </div>

      </div> <!-- adminUI -->

    </main>
  </div>

  <script>
  // ---------- CONFIGURE FIREBASE ----------
  // Replace with your project's config
  const firebaseConfig = {
    apiKey: "PASTE_API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    // ...other keys...
  };
  // init
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- UI refs ----------
  const btnShowLogin = document.getElementById('btnShowLogin');
  const loginBox = document.getElementById('loginBox');
  const loginBtn = document.getElementById('loginBtn');
  const cancelLogin = document.getElementById('cancelLogin');
  const loginError = document.getElementById('loginError');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const btnLogout = document.getElementById('btnLogout');
  const authSection = document.getElementById('authSection');
  const adminUI = document.getElementById('adminUI');
  const notAuth = document.getElementById('notAuth');
  const btnSignOut2 = document.getElementById('btnSignOut2');

  // account fields
  const meName = document.getElementById('meName');
  const meEmail = document.getElementById('meEmail');
  const meRole = document.getElementById('meRole');
  const sideName = document.getElementById('sideName');

  // staff table
  const staffTableBody = document.querySelector('#staffTable tbody');
  const pendingTableBody = document.querySelector('#pendingTable tbody');
  const staffSearch = document.getElementById('staffSearch');
  const refreshBtn = document.getElementById('refreshBtn');
  const saveAllBtn = document.getElementById('saveAllBtn');
  const staffStatus = document.getElementById('staffStatus');

  // settings fields
  const setSchoolName = document.getElementById('setSchoolName');
  const setAcademicYear = document.getElementById('setAcademicYear');
  const setGradingNote = document.getElementById('setGradingNote');
  const saveSettingsBtn = document.getElementById('saveSettings');
  const settingsStatus = document.getElementById('settingsStatus');

  // local model (client-side)
  let staffList = [];
  let pendingList = [];
  let currentUser = null;
  let currentStaffRecord = null; // staff doc for current user (to check role)

  // ---------- Auth UI ----------
  btnShowLogin.addEventListener('click', ()=> { loginBox.classList.toggle('hidden'); loginError.innerText=''; });
  cancelLogin.addEventListener('click', ()=> loginBox.classList.add('hidden'));

  loginBtn.addEventListener('click', async ()=>{
    const email = loginEmail.value.trim();
    const pw = loginPassword.value;
    loginError.innerText = '';
    if(!email || !pw){ loginError.innerText = 'Ingiza email na password'; return; }
    try{
      await auth.signInWithEmailAndPassword(email, pw);
      loginBox.classList.add('hidden');
    }catch(err){
      console.error(err);
      loginError.innerText = err.message || 'Login failed';
    }
  });

  btnLogout.addEventListener('click', ()=> auth.signOut());
  btnSignOut2.addEventListener('click', ()=> auth.signOut());

  // ---------- Auth state listener ----------
  auth.onAuthStateChanged(async (user)=>{
    currentUser = user;
    if(user){
      // show signout button
      btnLogout.classList.remove('hidden');
      authSection.classList.add('hidden');
      sideName.innerText = user.email || user.displayName || 'User';

      // load staff record for this uid if exists
      try{
        // try doc by uid
        const staffDocRef = db.collection('staff').doc(user.uid);
        const staffSnap = await staffDocRef.get();
        if(staffSnap.exists){
          currentStaffRecord = { id: staffSnap.id, ...staffSnap.data() };
        } else {
          // fallback: search by email
          const q = await db.collection('staff').where('email','==', user.email).limit(1).get();
          if(!q.empty){ currentStaffRecord = { id: q.docs[0].id, ...q.docs[0].data() }; }
        }

        // check role
        const role = currentStaffRecord ? currentStaffRecord.role : null;
        meName.value = currentStaffRecord ? currentStaffRecord.name : (user.displayName || '');
        meEmail.value = user.email || '';
        meRole.value = role || '‚Äî';

        if(role && role.toLowerCase().includes('admin')){
          // authorized: show admin UI
          notAuth.classList.add('hidden');
          adminUI.classList.remove('hidden');
          loadStaff();
          loadPending();
          loadSettings();
        } else {
          // not authorized
          adminUI.classList.add('hidden');
          notAuth.classList.remove('hidden');
        }

      }catch(err){
        console.error('Error fetching staff record', err);
        adminUI.classList.add('hidden');
        notAuth.classList.remove('hidden');
      }
    } else {
      // not signed in
      btnLogout.classList.add('hidden');
      authSection.classList.remove('hidden');
      adminUI.classList.add('hidden');
      notAuth.classList.add('hidden');
      sideName.innerText = '‚Äî';
      meName.value = ''; meEmail.value=''; meRole.value='';
    }
  });

  // ---------- Firestore data functions ----------
  async function loadStaff(){
    staffTableBody.innerHTML = '<tr><td colspan="7" class="small">Loading staff...</td></tr>';
    try{
      const snap = await db.collection('staff').orderBy('name','asc').get();
      staffList = snap.docs.map(d=> ({ id: d.id, ...d.data() }) );
      renderStaffTable(staffList);
    }catch(err){
      console.error(err);
      staffTableBody.innerHTML = '<tr><td colspan="7" class="small">Imeshindikana kupakia staff</td></tr>';
    }
  }

  function renderStaffTable(list){
    if(!list || list.length===0){ staffTableBody.innerHTML = '<tr><td colspan="7" class="small">Hakuna staff.</td></tr>'; return; }
    const rows = list.map(s=>{
      const checked = s.active ? 'checked' : '';
      return `<tr data-id="${s.id}">
        <td><strong>${escapeHtml(s.name)}</strong></td>
        <td>${escapeHtml(s.email)}</td>
        <td>
          <select class="roleSelect">
            <option ${s.role==='Admin'?'selected':''}>Admin</option>
            <option ${s.role==='Headmaster'?'selected':''}>Headmaster</option>
            <option ${s.role==='Academic'?'selected':''}>Academic</option>
            <option ${s.role==='Class Teacher'?'selected':''}>Class Teacher</option>
          </select>
        </td>
        <td><input class="input mainClass" value="${escapeHtml(s.mainClass||'')}" /></td>
        <td><button class="toggle ${s.active? 'checked':''}" data-id="${s.id}"></button></td>
        <td>${s.updated || ''}</td>
        <td style="white-space:nowrap"><button class="btn small saveRow" data-id="${s.id}" style="padding:6px 8px">Save</button></td>
      </tr>`;
    }).join('');
    staffTableBody.innerHTML = rows;
  }

  async function loadPending(){
    pendingTableBody.innerHTML = '<tr><td colspan="5" class="small">Loading pending...</td></tr>';
    try{
      const snap = await db.collection('pending_staff').orderBy('createdAt','asc').get();
      pendingList = snap.docs.map(d=> ({ id:d.id, ...d.data() }) );
      renderPending(pendingList);
    }catch(err){
      console.error(err);
      pendingTableBody.innerHTML = '<tr><td colspan="5" class="small">Imeshindikana kupakia pending</td></tr>';
    }
  }

  function renderPending(list){
    if(!list || list.length===0){ pendingTableBody.innerHTML = '<tr><td colspan="5" class="small">Hakuna pending staff.</td></tr>'; return; }
    const rows = list.map(p=>`
      <tr data-id="${p.id}">
        <td>${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.email)}</td>
        <td>${escapeHtml(p.requestedRole || p.role || 'Class Teacher')}</td>
        <td><button class="toggle ${p.active?'checked':''}" data-id="${p.id}"></button></td>
        <td><button class="btn small applyPending" data-id="${p.id}">Apply</button></td>
      </tr>
    `).join('');
    pendingTableBody.innerHTML = rows;
  }

  async function loadSettings(){
    try{
      const doc = await db.collection('settings').doc('global').get();
      if(doc.exists){
        const data = doc.data();
        setSchoolName.value = data.schoolName || '';
        setAcademicYear.value = data.academicYear || '';
        setGradingNote.value = data.gradingNote || '';
        settingsStatus.innerText = '';
      } else {
        settingsStatus.innerText = 'No settings found (will create on save)';
      }
    }catch(err){
      console.error(err);
      settingsStatus.innerText = 'Failed to load settings';
    }
  }

  // ---------- event delegation for table actions ----------
  document.addEventListener('click', async (ev)=>{
    const t = ev.target;
    if(t.matches('.toggle')){
      t.classList.toggle('checked');
      const id = t.getAttribute('data-id');
      // reflect only visually; Save will persist
      staffStatus.innerText = 'Toggle changed (remember to Save)';
      setTimeout(()=> staffStatus.innerText = '', 1500);
    } else if(t.matches('.saveRow')){
      const id = t.getAttribute('data-id');
      const tr = document.querySelector(`tr[data-id="${id}"]`);
      if(!tr) return;
      const role = tr.querySelector('.roleSelect').value;
      const mainClass = tr.querySelector('.mainClass').value;
      const active = tr.querySelector('.toggle').classList.contains('checked');
      try{
        await db.collection('staff').doc(id).set({ role, mainClass, active, updated: new Date().toISOString() }, { merge:true });
        staffStatus.innerText = 'Saved';
        setTimeout(()=> staffStatus.innerText = '', 1500);
        loadStaff();
      }catch(err){
        console.error(err); alert('Save failed: '+err.message);
      }
    } else if(t.matches('.applyPending')){
      const id = t.getAttribute('data-id');
      // move pending to staff collection
      try{
        const pdoc = await db.collection('pending_staff').doc(id).get();
        if(!pdoc.exists) { alert('Pending not found'); return; }
        const data = pdoc.data();
        // create staff doc (use generated id)
        const newStaff = {
          name: data.name,
          email: data.email,
          role: data.requestedRole || data.role || 'Class Teacher',
          mainClass: data.mainClass || '',
          active: true,
          updated: new Date().toISOString()
        };
        await db.collection('staff').add(newStaff);
        await db.collection('pending_staff').doc(id).delete();
        loadStaff(); loadPending();
        flash('#staffStatus','Applied pending');
      }catch(err){
        console.error(err); alert('Apply failed: '+err.message);
      }
    }
  });

  // search filter
  staffSearch.addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    if(!q) renderStaffTable(staffList);
    else renderStaffTable(staffList.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q)));
  });

  refreshBtn.addEventListener('click', ()=> { loadStaff(); loadPending(); flash('#staffStatus','Refreshed'); });

  // save all visible edits (gathers rows and writes in batch)
  saveAllBtn.addEventListener('click', async ()=>{
    const rows = Array.from(document.querySelectorAll('#staffTable tbody tr[data-id]'));
    const batch = db.batch();
    rows.forEach(r=>{
      const id = r.getAttribute('data-id');
      const role = r.querySelector('.roleSelect').value;
      const mainClass = r.querySelector('.mainClass').value;
      const active = r.querySelector('.toggle').classList.contains('checked');
      const ref = db.collection('staff').doc(id);
      batch.set(ref, { role, mainClass, active, updated: new Date().toISOString() }, { merge:true });
    });
    try{
      await batch.commit();
      flash('#staffStatus','All saved');
      loadStaff();
    }catch(err){
      console.error(err); alert('Batch save failed: '+err.message);
    }
  });

  // settings save
  saveSettingsBtn.addEventListener('click', async ()=>{
    const payload = {
      schoolName: setSchoolName.value.trim(),
      academicYear: setAcademicYear.value.trim(),
      gradingNote: setGradingNote.value.trim(),
      updated: new Date().toISOString()
    };
    try{
      await db.collection('settings').doc('global').set(payload, { merge:true });
      settingsStatus.innerText = 'Saved';
      setTimeout(()=> settingsStatus.innerText = '', 1800);
    }catch(err){
      console.error(err); settingsStatus.innerText = 'Save failed';
    }
  });

  // helper functions
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  function flash(sel, text){
    const el = document.querySelector(sel);
    if(!el) return;
    el.innerText = text;
    setTimeout(()=> el.innerText = '', 2000);
  }

  // ---------- initial guidance ----------
  // If you want admin to be recognized only by custom claims (safer),
  // set a custom claim 'admin': true on the user and check via auth.currentUser.getIdTokenResult().
  // This example checks role in 'staff' collection for simplicity.

  </script>
</body>
</html>

