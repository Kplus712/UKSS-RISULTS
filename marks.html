<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS â€” Marks & Students</title>
  <link rel="stylesheet" href="./style.css" />

  <!-- EARLY GUARD: run BEFORE firebase UI to prevent flash
       - If sessionStorage.justSignedIn === '1' -> allow page load (DO NOT clear flag here)
       - Otherwise redirect immediately to index.html (login)
  -->
  <script>
    (function(){
      try {
        console.log('[GUARD] early guard running on marks.html');

        var just = null;
        try { just = sessionStorage.getItem('justSignedIn'); } catch(e) { console.warn('[GUARD] sessionStorage read failed', e); }

        if (just !== '1') {
          console.warn('[GUARD] justSignedIn not found -> redirecting to index.html');
          try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
          window.location.replace('index.html');
          return;
        }

        // Allowed to load â€” DO NOT clear the flag yet.
        console.log('[GUARD] justSignedIn found -> allowing page load (flag will be validated/consumed by post-load guard).');
      } catch (err) {
        console.error('[GUARD] early guard fatal', err);
        try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
        window.location.replace('index.html');
      }
    })();
  </script>

  <style>
    /* (abbreviated styles for brevity, same as your previous design) */
    .topbar { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; }
    .stepper { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .step-pill { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.08); font-size:11px; display:flex; align-items:center; gap:6px; opacity:0.7; }
    .step-pill.active{ background:linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; opacity:1; box-shadow:0 6px 16px rgba(37,99,235,0.35); border:none; }
    .tabs{ display:flex; border-radius:999px; background:rgba(15,23,42,0.65); padding:3px; width:max-content; }
    .tab-btn{ border:none; background:transparent; padding:6px 14px; font-size:12px; border-radius:999px; cursor:pointer; opacity:0.7; white-space:nowrap; }
    .tab-btn.active{ background:rgba(15,23,42,0.95); opacity:1; box-shadow:0 4px 10px rgba(0,0,0,0.4); }
    .grid-2{ display:grid; grid-template-columns:minmax(0,1.3fr) minmax(0,1fr); gap:16px; }
    @media(max-width:900px){ .grid-2{ grid-template-columns:minmax(0,1fr); } }
    .table-mini{ width:100%; border-collapse:collapse; font-size:12px; }
    .matrix-table{ width:100%; border-collapse:collapse; font-size:11px; overflow:auto; }
    .matrix-input{ width:64px; padding:3px 4px; border-radius:6px; border:1px solid rgba(148,163,184,0.8); background:rgba(15,23,42,0.85); color:#e5e7eb; font-size:11px; text-align:center; }
    #guardDebug { display:none; font-size:12px; color:#f97373; margin-bottom:8px; }
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">UK</div>
      <div>
        <div class="brand-title">UKSS</div>
        <div class="brand-sub">Results Management</div>
      </div>
    </div>

    <nav class="nav">
      <a href="marks.html" class="active">ğŸ  Marks & Students</a>
      <a href="results.html">ğŸ“„ Results</a>
      <a href="ranking.html">ğŸ† Ranking</a>
      <a href="behaviour.html">ğŸ§­ Behaviour</a>
      <a href="sms.html">ğŸ“¨ SMS</a>
      <a href="sms_logs.html">ğŸ§¾ SMS Logs</a>
      <a href="admin.html" id="navAdminLink">ğŸ” Admin</a>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <div>
        <h2>ğŸ“˜ Marks & Students</h2>
        <p class="small">
          Hatua: (1) Tengeneza madarasa Form Iâ€“IV âœ (2) Ongeza masomo âœ (3) Sajili wanafunzi âœ (4) Chagua mtihani na ujaze alama.
        </p>

        <div class="stepper">
          <div class="step-pill" id="stepClassPill"><span class="badge">1</span> Madarasa (Form Iâ€“IV)</div>
          <div class="step-pill" id="stepStudentsPill"><span class="badge">2</span> Masomo ya Darasa</div>
          <div class="step-pill" id="stepExamPill"><span class="badge">3</span> Usajili wa Wanafunzi (F1â€“F4)</div>
          <div class="step-pill" id="stepMarksPill"><span class="badge">4</span> Mitihani & Alama</div>
        </div>
      </div>

      <div class="top-actions">
        <button id="loadSampleBtn" class="btn btn-ghost">Load Sample</button>
      </div>
    </header>

    <!-- rest of page UI (unchanged) -->
    <section class="card">
      <div class="row row-wrap">
        <div class="field">
          <label class="label">Class (Form & Stream)</label>
          <select id="classSelect" class="input"></select>
        </div>
        <button id="addClassBtn" class="btn btn-primary">+ Add Class</button>
        <div class="field">
          <label class="label">Exam in this class</label>
          <select id="examSelect" class="input"></select>
        </div>
        <button id="addExamBtn" class="btn btn-ghost">+ Add Exam (Test, Midterm, Annual)</button>
      </div>

      <div class="stats-bar">
        <div class="stat-chip">ğŸ‘¥ Students: <span id="statStudents">0</span></div>
        <div class="stat-chip">ğŸ“š Subjects: <span id="statSubjects">0</span></div>
        <div class="stat-chip">ğŸ§ª Current exam: <span id="statExamName">â€”</span></div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;">
        <div class="tabs">
          <button class="tab-btn active" data-tab="studentsTab">Students & Subjects</button>
          <button class="tab-btn" data-tab="marksTab">Marks Matrix</button>
        </div>
        <button id="generateReportsBtn" class="btn btn-primary">Generate Reports</button>
      </div>

      <div id="studentsTab" class="tab-panel">
        <div class="grid-2">
          <div>
            <h3>Register Student (Form Iâ€“IV)</h3>
            <div class="form-row" style="margin-top:10px;">
              <div class="field"><label class="label">Admission No</label><input id="stuAdmission" class="input" placeholder="F1A/001" autocomplete="off" /></div>
              <div class="field"><label class="label">First name</label><input id="stuFirst" class="input" placeholder="Kelvin" autocomplete="given-name" /></div>
              <div class="field"><label class="label">Last name</label><input id="stuLast" class="input" placeholder="Deogratias" autocomplete="family-name" /></div>
            </div>

            <div class="form-row" style="margin-top:10px;">
              <div class="field">
                <label class="label">Sex</label>
                <select id="stuSex" class="input"><option value="">--</option><option value="F">F</option><option value="M">M</option></select>
              </div>
              <div class="field"><label class="label">Guardian phone</label><input id="stuPhone" class="input" placeholder="0712345678" autocomplete="tel" /></div>
            </div>

            <div class="row" style="margin-top:12px;"><button id="addStudentBtn" class="btn btn-primary">Save Student</button></div>

            <hr style="margin:16px 0;opacity:0.15;border:none;border-top:1px solid #1f2937;">
            <h3>Subjects in this class</h3>
            <div class="form-row" style="margin-top:10px;">
              <div class="field"><label class="label">Subject code</label><input id="subCode" class="input" placeholder="BUS" autocomplete="off" /></div>
              <div class="field"><label class="label">Subject name</label><input id="subName" class="input" placeholder="Business Studies" autocomplete="off" /></div>
            </div>
            <div class="row" style="margin-top:10px;"><button id="addSubjectBtn" class="btn btn-ghost">+ Add Subject</button></div>
          </div>

          <div>
            <h3>Overview</h3>
            <div style="margin-top:10px;">
              <p class="label">Students</p>
              <div class="list-box small" style="max-height:200px;overflow:auto;">
                <table class="table-mini" id="studentsMiniTable"><thead><tr><th>#</th><th>Adm</th><th>Name</th><th>Sex</th><th>Phone</th></tr></thead><tbody></tbody></table>
              </div>
            </div>

            <div style="margin-top:14px;">
              <p class="label">Subjects</p>
              <div class="list-box small" style="max-height:160px;overflow:auto;">
                <table class="table-mini" id="subjectsMiniTable"><thead><tr><th>Code</th><th>Name</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="marksTab" class="tab-panel" style="display:none;">
        <div class="matrix-header">
          <div><h3>Marks Matrix</h3><p class="small">Chagua darasa na mtihani, kisha jaza alama za mwisho za kila somo (0 â€“ 100).</p></div>
          <div class="pill">Exam: <span id="pillExamLabel">â€”</span></div>
        </div>
        <div id="marksMatrixWrap" class="matrix-wrap"></div>
      </div>
    </section>
  </main>
</div>

<div id="guardDebug" style="position:fixed;right:12px;bottom:12px;background:#111827aa;padding:8px;border-radius:8px;color:#fff;display:none;"></div>

<!-- Firebase CDN v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- App scripts -->
<script src="./js/database.js"></script>

<!-- POST-LOAD GUARD: wait for Firebase onAuthStateChanged or timeout -->
<script>
  (function(){
    const LOG = function(){ console.log('[GUARD]','MARKS',...arguments); };
    const WARN = function(){ console.warn('[GUARD]','MARKS',...arguments); };

    async function waitForAuthState(timeoutMs = 3000){
      return new Promise(resolve => {
        let done = false;
        let timer = setTimeout(()=> {
          if(done) return;
          done = true;
          WARN('waitForAuthState timed out after', timeoutMs, 'ms');
          resolve(null);
        }, timeoutMs);

        if(!window.firebase || !firebase.auth){
          clearTimeout(timer);
          done = true;
          WARN('firebase.auth not present while waiting');
          resolve(null);
          return;
        }

        const unsub = firebase.auth().onAuthStateChanged(user => {
          if(done) return;
          done = true;
          clearTimeout(timer);
          unsub();
          LOG('onAuthStateChanged fired ->', user ? user.email : null);
          resolve(user);
        });
      });
    }

    (async function(){
      try{
        LOG('post-load guard starting; waiting for firebase auth confirmation (3s max)');
        const user = await waitForAuthState(3000);

        const allowed = (function(){
          try { return sessionStorage.getItem('justSignedIn') === '1'; } catch(e){ return false; }
        })();

        LOG('post-load: user=', user ? user.email : null, 'allowedFlag=', allowed);

        if(!user){
          // no user after wait: redirect to login
          WARN('No firebase user found -> redirect to index.html');
          try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
          window.location.replace('index.html');
          return;
        }

        // user exists
        if(user && allowed){
          // success: consume flag now and continue
          try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
          LOG('Authenticated user confirmed and flag present -> continuing');
          return;
        }

        // user exists but not freshly signed in: sign out and redirect
        if(user && !allowed){
          WARN('User present but justSignedIn flag missing -> signing out and redirecting');
          try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
          firebase.auth().signOut().finally(()=> window.location.replace('index.html'));
          return;
        }

      }catch(err){
        console.error('[GUARD] post-load fatal', err);
        try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
        window.location.replace('index.html');
      }
    })();
  })();
</script>

<!-- Your page logic -->
<script src="./js/marks.js"></script>

</body>
</html>

