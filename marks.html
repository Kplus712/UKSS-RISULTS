<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKSS ‚Äî Marks & Students</title>
  <link rel="stylesheet" href="./style.css" />

  <!-- ===== EARLY GUARD: place BEFORE firebase or any UI to prevent flash =====
       Behavior:
       - If sessionStorage.justSignedIn === '1' -> allow page load once, then clear flag.
       - Otherwise redirect immediately to login.html (prevents marks.html from opening).
       - This runs very early so page content won't flash.
  -->
  <script>
    (function(){
      try {
        console.log('[GUARD] early guard running on marks.html');

        // Allow once-per-login transition (set by login form on successful signIn)
        var just = null;
        try { just = sessionStorage.getItem('justSignedIn'); } catch(e) { console.warn('[GUARD] sessionStorage read failed', e); }

        // If not freshly signed in, block and redirect immediately.
        if (just !== '1') {
          console.warn('[GUARD] justSignedIn not found -> redirecting to login.html');
          // ensure no stale flag remains
          try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
          // Use replace so back button doesn't go back to protected page
          window.location.replace('login.html');
          return;
        }

        // If we reach here, allow page load once and clear the flag immediately.
        try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
        console.log('[GUARD] justSignedIn found -> allowing page load (flag cleared).');
      } catch (err) {
        console.error('[GUARD] fatal guard error', err);
        try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
        window.location.replace('login.html');
      }
    })();
  </script>

  <style>
    /* ===== extra modern tweaks for this page only ===== */

    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }

    .stepper {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .step-pill {
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      opacity:0.7;
    }
    .step-pill.active{
      background:linear-gradient(135deg,#2563eb,#3b82f6);
      color:#fff;
      opacity:1;
      box-shadow:0 6px 16px rgba(37,99,235,0.35);
      border:none;
    }
    .step-pill span.badge{
      width:18px;
      height:18px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      background:rgba(15,23,42,0.9);
    }

    .tabs{
      display:flex;
      border-radius:999px;
      background:rgba(15,23,42,0.65);
      padding:3px;
      width:max-content;
    }
    .tab-btn{
      border:none;
      background:transparent;
      padding:6px 14px;
      font-size:12px;
      border-radius:999px;
      cursor:pointer;
      opacity:0.7;
      white-space:nowrap;
    }
    .tab-btn.active{
      background:rgba(15,23,42,0.95);
      opacity:1;
      box-shadow:0 4px 10px rgba(0,0,0,0.4);
    }

    .grid-2{
      display:grid;
      grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .grid-2{
        grid-template-columns:minmax(0,1fr);
      }
    }

    .stats-bar{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
      font-size:11px;
    }
    .stat-chip{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.3);
    }

    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .form-row .field{
      flex:1 1 160px;
    }

    .table-mini{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .table-mini th,
    .table-mini td{
      padding:6px 8px;
      border-bottom:1px solid rgba(148,163,184,0.15);
    }
    .table-mini thead{
      background:rgba(15,23,42,0.9);
    }
    .table-mini tbody tr:hover{
      background:rgba(15,23,42,0.6);
    }

    .pill{
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.35);
    }

    .matrix-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:12px;
      flex-wrap:wrap;
    }

    .matrix-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      overflow:auto;
    }
    .matrix-table th,
    .matrix-table td{
      border:1px solid rgba(148,163,184,0.35);
      padding:4px 6px;
      text-align:center;
      white-space:nowrap;
    }
    .matrix-table thead{
      position:sticky;
      top:0;
      background:rgba(15,23,42,0.98);
      z-index:1;
    }
    .matrix-input{
      width:64px;
      padding:3px 4px;
      border-radius:6px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.85);
      color:#e5e7eb;
      font-size:11px;
      text-align:center;
    }
    .matrix-input:focus{
      outline:none;
      border-color:#3b82f6;
      box-shadow:0 0 0 1px rgba(59,130,246,0.5);
    }

    /* lightweight guard notice for debug (hidden normally) */
    #guardDebug { display:none; font-size:12px; color:#f97373; margin-bottom:8px; }
  </style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">UK</div>
      <div>
        <div class="brand-title">UKSS</div>
        <div class="brand-sub">Results Management</div>
      </div>
    </div>

    <nav class="nav">
      <a href="marks.html" class="active">üè† Marks & Students</a>
      <a href="results.html">üìÑ Results</a>
      <a href="ranking.html">üèÜ Ranking</a>
      <a href="behaviour.html">üß≠ Behaviour</a>
      <a href="sms.html">üì® SMS</a>
      <a href="sms_logs.html">üßæ SMS Logs</a>
      <a href="admin.html" id="navAdminLink">üîê Admin</a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <header class="topbar">
      <div>
        <h2>üìò Marks & Students</h2>
        <p class="small">
          Hatua: (1) Tengeneza madarasa Form I‚ÄìIV ‚ûú 
          (2) Ongeza masomo ‚ûú 
          (3) Sajili wanafunzi Form I‚ÄìF4 ‚ûú 
          (4) Chagua mtihani na ujaze alama.
        </p>

        <div class="stepper">
          <div class="step-pill" id="stepClassPill">
            <span class="badge">1</span> Madarasa (Form I‚ÄìIV)
          </div>
          <div class="step-pill" id="stepStudentsPill">
            <span class="badge">2</span> Masomo ya Darasa
          </div>
          <div class="step-pill" id="stepExamPill">
            <span class="badge">3</span> Usajili wa Wanafunzi (F1‚ÄìF4)
          </div>
          <div class="step-pill" id="stepMarksPill">
            <span class="badge">4</span> Mitihani & Alama
          </div>
        </div>
      </div>

      <div class="top-actions">
        <button id="loadSampleBtn" class="btn btn-ghost">Load Sample</button>
      </div>
    </header>

    <!-- CLASS + EXAM CONTROLS -->
    <section class="card">
      <div class="row row-wrap">
        <div class="field">
          <label class="label">Class (Form & Stream)</label>
          <select id="classSelect" class="input"></select>
        </div>

        <button id="addClassBtn" class="btn btn-primary">+ Add Class</button>

        <div class="field">
          <label class="label">Exam in this class</label>
          <select id="examSelect" class="input"></select>
        </div>

        <button id="addExamBtn" class="btn btn-ghost">+ Add Exam (Test, Midterm, Annual)</button>
      </div>

      <div class="stats-bar">
        <div class="stat-chip">
          üë• Students: <span id="statStudents">0</span>
        </div>
        <div class="stat-chip">
          üìö Subjects: <span id="statSubjects">0</span>
        </div>
        <div class="stat-chip">
          üß™ Current exam: <span id="statExamName">‚Äî</span>
        </div>
      </div>
    </section>

    <!-- TABS: STUDENTS | MARKS -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;">
        <div class="tabs">
          <button class="tab-btn active" data-tab="studentsTab">Students & Subjects</button>
          <button class="tab-btn" data-tab="marksTab">Marks Matrix</button>
        </div>
        <button id="generateReportsBtn" class="btn btn-primary">Generate Reports</button>
      </div>

      <!-- STUDENTS TAB -->
      <div id="studentsTab" class="tab-panel">
        <div class="grid-2">
          <!-- Student registration -->
          <div>
            <h3>Register Student (Form I‚ÄìIV)</h3>
            <p class="small">
              Sajili wanafunzi wote wa Form I hadi Form IV kwenye madarasa yao
              kabla ya kuingiza alama.
            </p>

            <div class="form-row" style="margin-top:10px;">
              <div class="field">
                <label class="label">Admission No</label>
                <input id="stuAdmission" class="input" placeholder="F1A/001" />
              </div>
              <div class="field">
                <label class="label">First name</label>
                <input id="stuFirst" class="input" placeholder="Kelvin" />
              </div>
              <div class="field">
                <label class="label">Last name</label>
                <input id="stuLast" class="input" placeholder="Deogratias" />
              </div>
            </div>

            <div class="form-row" style="margin-top:10px;">
              <div class="field">
                <label class="label">Sex</label>
                <select id="stuSex" class="input">
                  <option value="">--</option>
                  <option value="F">F</option>
                  <option value="M">M</option>
                </select>
              </div>
              <div class="field">
                <label class="label">Guardian phone</label>
                <input id="stuPhone" class="input" placeholder="0712345678" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button id="addStudentBtn" class="btn btn-primary">Save Student</button>
            </div>

            <hr style="margin:16px 0;opacity:0.15;border:none;border-top:1px solid #1f2937;">

            <!-- Subjects management -->
            <h3>Subjects in this class</h3>
            <p class="small">Tumia codes fupi kama HIST, GEO, KIS, ENG, BUS n.k.</p>

            <div class="form-row" style="margin-top:10px;">
              <div class="field">
                <label class="label">Subject code</label>
                <input id="subCode" class="input" placeholder="BUS" />
              </div>
              <div class="field">
                <label class="label">Subject name</label>
                <input id="subName" class="input" placeholder="Business Studies" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button id="addSubjectBtn" class="btn btn-ghost">+ Add Subject</button>
            </div>
          </div>

          <!-- Lists -->
          <div>
            <h3>Overview</h3>
            <p class="small">Wanafunzi na masomo ya darasa hili (Form husika).</p>

            <div style="margin-top:10px;">
              <p class="label">Students</p>
              <div class="list-box small" style="max-height:200px;overflow:auto;">
                <table class="table-mini" id="studentsMiniTable">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Adm</th>
                      <th>Name</th>
                      <th>Sex</th>
                      <th>Phone</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div style="margin-top:14px;">
              <p class="label">Subjects</p>
              <div class="list-box small" style="max-height:160px;overflow:auto;">
                <table class="table-mini" id="subjectsMiniTable">
                  <thead>
                    <tr>
                      <th>Code</th>
                      <th>Name</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- MARKS TAB -->
      <div id="marksTab" class="tab-panel" style="display:none;">
        <div class="matrix-header">
          <div>
            <h3>Marks Matrix</h3>
            <p class="small">
              Chagua darasa na mtihani, kisha jaza alama za mwisho za kila somo (0 ‚Äì 100).<br/>
              Mfano: BUS = 70, MATH = 55, KIS = 82.
            </p>
          </div>
          <div class="pill">
            Exam: <span id="pillExamLabel">‚Äî</span>
          </div>
        </div>

        <div id="marksMatrixWrap" class="matrix-wrap"></div>
      </div>
    </section>

  </main>
</div>

<!-- Optional hidden debug box to show guard logs on UI (turn on when debugging) -->
<div id="guardDebug" style="position:fixed;right:12px;bottom:12px;background:#111827aa;padding:8px;border-radius:8px;color:#fff;display:none;"></div>

<!-- Firebase CDN v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- App scripts -->
<script src="./js/database.js"></script>

<!-- Quick post-load safety: if by any chance firebase.currentUser exists but the session was not "justSignedIn",
     we sign them out and redirect. This is an extra layer (runs after firebase is available). -->
<script>
  (function(){
    // run after database.js loaded
    try {
      console.log('[GUARD] post-load safety running');
      // only run if firebase auth is available
      if(window.firebase && firebase.auth){
        firebase.auth().onAuthStateChanged(function(user){
          console.log('[GUARD] post-load onAuthStateChanged user=', user ? user.email : null);
          // if there is a user but page was not allowed by justSignedIn flag, force sign out
          var allowed = false;
          try { allowed = sessionStorage.getItem('justSignedIn') === '1'; } catch(e){ allowed = false; }
          if(user && !allowed){
            console.warn('[GUARD] user session exists but not freshly signed in -> signing out and redirecting');
            sessionStorage.removeItem('justSignedIn');
            firebase.auth().signOut().then(function(){
              window.location.replace('login.html');
            }).catch(function(e){
              console.warn('[GUARD] signOut failed', e);
              window.location.replace('login.html');
            });
            return;
          }
          // if allowed and user exists, clear the flag (it was consumed by the head guard earlier, but double-safe)
          if(allowed){
            try { sessionStorage.removeItem('justSignedIn'); } catch(e){}
            console.log('[GUARD] allowed session (justSignedIn) ‚Äî continuing.');
          }
        });
      } else {
        console.log('[GUARD] firebase.auth not available yet for post-load safety');
      }
    } catch(err){
      console.error('[GUARD] post-load safety error', err);
    }
  })();
</script>

<!-- Page logic: your marks.js should remain the primary script to load lists, exams, marks etc.
     If you want, you can also paste an updated marks.js and I will adapt it to check role and hide Admin link. -->
<script src="./js/marks.js"></script>

</body>
</html>



